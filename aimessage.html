<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Message ‚Äî AutoPost Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Vercel Analytics -->
    <script defer src="https://va.vercel-scripts.com/v1/script.js"></script>
    
    <style>
        :root {
            --bg: #07090f;
            --surface: #0d1117;
            --surface2: #151b25;
            --surface3: #1c2432;
            --border: #1e2a3a;
            --border2: #253347;
            --cyan: #06b6d4;
            --cyan-dim: #06b6d418;
            --amber: #f59e0b;
            --amber-dim: #f59e0b18;
            --green: #10b981;
            --green-dim: #10b98118;
            --red: #ef4444;
            --red-dim: #ef444418;
            --purple: #a855f7;
            --purple-dim: #a855f718;
            --muted: #4a5568;
            --muted2: #718096;
            --text: #e2e8f0;
            --text2: #a0aec0;
            --mono: 'JetBrains Mono', monospace;
            --sans: 'Space Grotesk', sans-serif;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--sans);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.025) 2px, rgba(0,0,0,.025) 4px);
            pointer-events: none;
            z-index: 9000;
        }

        /* Header */
        header {
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            padding: 0 28px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 15px;
            color: var(--text);
            text-decoration: none;
        }
        
        .logo-dot {
            width: 8px;
            height: 8px;
            background: var(--amber);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--amber);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        nav {
            display: flex;
            gap: 4px;
        }
        
        .nav-item {
            padding: 6px 13px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--muted2);
            text-decoration: none;
            transition: all .15s;
            border: 1px solid transparent;
        }
        
        .nav-item:hover {
            color: var(--text);
            background: var(--surface2);
        }
        
        .nav-item.active {
            color: var(--amber);
            background: var(--amber-dim);
            border-color: var(--border2);
        }
        
        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quota-bar-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--mono);
            font-size: 11px;
            color: var(--muted2);
        }
        
        .quota-bar {
            width: 80px;
            height: 5px;
            background: var(--surface2);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .quota-bar-fill {
            height: 100%;
            background: var(--green);
            border-radius: 3px;
            transition: width .4s;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 9px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
        }
        
        .badge-premium {
            background: var(--green-dim);
            color: var(--green);
            border: 1px solid var(--green);
        }
        
        .badge-trial {
            background: var(--amber-dim);
            color: var(--amber);
            border: 1px solid var(--amber);
        }
        
        .logout-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--muted2);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all .15s;
        }
        
        .logout-btn:hover {
            border-color: var(--red);
            color: var(--red);
        }

        /* Main layout */
        main {
            flex: 1;
            padding: 24px 28px;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 18px;
            max-width: 1180px;
            width: 100%;
            margin: 0 auto;
            align-items: start;
        }
        
        @media (max-width: 860px) {
            main {
                grid-template-columns: 1fr;
                padding: 18px;
            }
        }

        /* Cards */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 14px;
        }
        
        .card-hdr {
            padding: 13px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .card-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .1em;
            color: var(--muted2);
            display: flex;
            align-items: center;
            gap: 7px;
        }
        
        .card-title::before {
            content: '';
            width: 3px;
            height: 12px;
            border-radius: 2px;
            background: var(--amber);
            display: inline-block;
        }
        
        .card-body {
            padding: 18px;
        }

        /* Forms */
        .fg {
            margin-bottom: 14px;
        }
        
        .fl {
            display: block;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .06em;
            color: var(--muted2);
            margin-bottom: 5px;
        }
        
        .fi, .fs {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border2);
            border-radius: 6px;
            color: var(--text);
            font-size: 13px;
            padding: 8px 11px;
            outline: none;
            font-family: var(--sans);
            transition: border-color .15s;
        }
        
        .fi:focus, .fs:focus {
            border-color: var(--cyan);
        }
        
        .fs {
            cursor: pointer;
        }
        
        .opt {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            cursor: pointer;
        }
        
        .opt input {
            accent-color: var(--amber);
            width: 14px;
            height: 14px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: var(--sans);
            transition: all .15s;
            text-decoration: none;
            white-space: nowrap;
        }
        
        .btn:disabled {
            opacity: .45;
            cursor: not-allowed;
        }
        
        .btn-amber {
            background: var(--amber);
            color: #000;
        }
        
        .btn-amber:hover:not(:disabled) {
            background: #fbbf24;
            transform: translateY(-1px);
        }
        
        .btn-cyan {
            background: var(--cyan);
            color: #000;
        }
        
        .btn-cyan:hover:not(:disabled) {
            background: #22d3ee;
            transform: translateY(-1px);
        }
        
        .btn-ghost {
            background: var(--surface2);
            color: var(--text2);
            border: 1px solid var(--border2);
        }
        
        .btn-ghost:hover:not(:disabled) {
            color: var(--text);
            border-color: var(--cyan);
        }
        
        .btn-sm {
            padding: 5px 11px;
            font-size: 12px;
        }
        
        .btn-full {
            width: 100%;
        }

        /* Match list */
        .match-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface2);
        }
        
        .match-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all .15s;
        }
        
        .match-item:last-child {
            border-bottom: none;
        }
        
        .match-item:hover {
            background: var(--surface3);
        }
        
        .match-item.sel {
            background: var(--amber-dim);
            border-left: 3px solid var(--amber);
        }
        
        .mi-teams {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .mi-score {
            color: var(--amber);
            font-family: var(--mono);
        }
        
        .mi-meta {
            font-size: 10px;
            color: var(--muted2);
            font-family: var(--mono);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-dot {
            width: 6px;
            height: 6px;
            background: var(--amber);
            border-radius: 50%;
            animation: blink 1s infinite;
            display: inline-block;
            margin-right: 4px;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: .15; }
        }

        /* Preview box */
        .preview-box {
            background: var(--surface2);
            border: 1px solid var(--border2);
            border-radius: 8px;
            min-height: 240px;
            padding: 18px;
            font-family: var(--mono);
            font-size: 13px;
            line-height: 1.7;
            color: var(--text);
            white-space: pre-wrap;
            word-break: break-word;
            position: relative;
        }
        
        .preview-placeholder {
            color: var(--muted2);
            font-family: var(--sans);
            font-style: italic;
            font-size: 13px;
        }
        
        .gen-overlay {
            position: absolute;
            inset: 0;
            border-radius: 8px;
            background: rgba(7, 9, 15, .95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .gen-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border2);
            border-top-color: var(--amber);
            border-radius: 50%;
            animation: spin .7s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .gen-label {
            font-size: 13px;
            color: var(--text2);
        }

        /* Widget */
        .widget-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--surface2);
            border: 1px solid var(--border2);
            border-radius: 8px;
            cursor: pointer;
            transition: border-color .15s;
            margin-bottom: 10px;
        }
        
        .widget-toggle:hover {
            border-color: var(--amber);
        }
        
        .match-widget {
            background: linear-gradient(145deg, #0d1117, #151b25);
            border: 1px solid var(--border2);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .match-widget::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 50% 0%, var(--amber-dim), transparent 70%);
            pointer-events: none;
        }
        
        .widget-league {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .widget-league img {
            width: 22px;
            height: 22px;
            object-fit: contain;
        }
        
        .widget-league-name {
            font-size: 11px;
            color: var(--muted2);
            font-family: var(--mono);
        }
        
        .widget-teams {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .widget-team {
            text-align: center;
        }
        
        .widget-team img {
            width: 56px;
            height: 56px;
            object-fit: contain;
            margin-bottom: 8px;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,.5));
        }
        
        .widget-team-name {
            font-size: 13px;
            font-weight: 600;
        }
        
        .widget-score-box {
            text-align: center;
        }
        
        .widget-score {
            font-family: var(--mono);
            font-size: 36px;
            font-weight: 700;
            color: var(--amber);
        }
        
        .widget-status {
            font-size: 11px;
            color: var(--muted2);
            font-family: var(--mono);
            margin-top: 4px;
        }
        
        .widget-events {
            border-top: 1px solid var(--border);
            padding-top: 12px;
            margin-top: 4px;
        }
        
        .widget-event {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 12px;
        }
        
        .widget-event-min {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--amber);
            min-width: 28px;
        }

        /* Channels */
        .ch-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .ch-row:last-child {
            border-bottom: none;
        }
        
        .ch-row label {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            cursor: pointer;
            font-size: 13px;
        }
        
        .ch-row input[type="checkbox"] {
            accent-color: var(--cyan);
            width: 16px;
            height: 16px;
        }

        /* Toast */
        #toast {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            background: var(--green);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
        }

        /* Data box */
        .data-box {
            background: var(--surface3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            font-family: var(--mono);
            font-size: 10px;
            color: var(--muted2);
            white-space: pre;
            overflow-x: auto;
            max-height: 120px;
            overflow-y: auto;
            margin-top: 10px;
            display: none;
        }

        /* Loading states */
        .loading {
            color: var(--muted2);
            text-align: center;
            padding: 20px;
            font-size: 12px;
        }
        
        .error {
            color: var(--red);
            text-align: center;
            padding: 20px;
            font-size: 12px;
        }

        /* Refresh button */
        .refresh-btn {
            background: none;
            border: 1px solid var(--border2);
            color: var(--muted2);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all .15s;
        }
        
        .refresh-btn:hover {
            border-color: var(--cyan);
            color: var(--cyan);
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">
            <div class="logo-dot"></div>
            AutoPost Pro
        </a>
        
        <nav>
            <a href="index.html" class="nav-item">Dashboard</a>
            <a href="manualmessage.html" class="nav-item">Manual</a>
            <a href="aimessage.html" class="nav-item active">AI Message</a>
        </nav>
        
        <div class="user-badge">
            <div class="quota-bar-wrap" id="quota-display">
                <span id="quota-txt">‚Äî</span>
                <div class="quota-bar">
                    <div class="quota-bar-fill" id="quota-fill" style="width:0%"></div>
                </div>
            </div>
            <span class="status-badge" id="status-badge">‚ö™ Loading</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>

    <main>
        <!-- LEFT COLUMN -->
        <div>
            <!-- Message Type Card -->
            <div class="card">
                <div class="card-hdr">
                    <div class="card-title">Message Type</div>
                </div>
                <div class="card-body">
                    <div class="fg">
                        <select class="fs" id="msg-type" onchange="toggleType()">
                            <option value="live">üî¥ Live Match Summary</option>
                            <option value="preview">üìÖ Match Preview + H2H</option>
                            <option value="standings">üèÜ League Standings</option>
                            <option value="digest">üìä Today's Fixtures Digest</option>
                        </select>
                    </div>

                    <!-- Match Selection Section -->
                    <div id="match-section">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <label class="fl" style="margin:0;">Select Match</label>
                            <button class="refresh-btn" onclick="loadMatches()">‚Üª Refresh</button>
                        </div>
                        <div id="match-list" class="match-list">
                            <div class="loading">Click Refresh to load matches</div>
                        </div>
                    </div>

                    <!-- League Selection Section -->
                    <div id="league-section" style="display: none;">
                        <div class="fg">
                            <label class="fl">League</label>
                            <select class="fs" id="league-sel"></select>
                        </div>
                        <div class="fg">
                            <label class="fl">Season</label>
                            <select class="fs" id="season-sel">
                                <option value="2024">2024/25</option>
                                <option value="2023">2023/24</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Options Card -->
            <div class="card">
                <div class="card-hdr">
                    <div class="card-title">AI Options</div>
                </div>
                <div class="card-body">
                    <div class="fg">
                        <label class="fl">Tone</label>
                        <select class="fs" id="tone">
                            <option value="professional">üì∞ Professional</option>
                            <option value="excited">üî• Excited & Energetic</option>
                            <option value="casual">üòé Casual & Friendly</option>
                            <option value="dramatic">‚ö° Dramatic</option>
                        </select>
                    </div>
                    
                    <div class="fg">
                        <label class="fl">Length</label>
                        <select class="fs" id="length">
                            <option value="short">Short (2‚Äì3 lines)</option>
                            <option value="medium" selected>Medium (4‚Äì6 lines)</option>
                            <option value="detailed">Detailed report (8‚Äì12 lines)</option>
                        </select>
                    </div>
                    
                    <label class="opt">
                        <input type="checkbox" id="inc-stats" checked> 
                        Include match stats (possession, shots, etc.)
                    </label>
                    
                    <label class="opt">
                        <input type="checkbox" id="inc-players" checked> 
                        Include top performers
                    </label>
                </div>
            </div>

            <!-- Generate Button -->
            <button class="btn btn-amber btn-full" id="gen-btn" onclick="generate()">
                ‚ú¶ Generate AI Message
            </button>

            <!-- Data Preview Box -->
            <div class="data-box" id="data-box"></div>
        </div>

        <!-- RIGHT COLUMN -->
        <div style="position: sticky; top: 70px;">
            <!-- Generated Message Card -->
            <div class="card">
                <div class="card-hdr">
                    <div class="card-title">Generated Message</div>
                    <div style="display: flex; gap: 6px;">
                        <button class="btn btn-ghost btn-sm" onclick="copyMsg()">üìã Copy</button>
                        <button class="btn btn-cyan btn-sm" onclick="sendAll()">üì§ Send</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="preview-box" id="preview-box">
                        <div class="preview-placeholder" id="preview-ph">
                            Select a match and click <strong style="color: var(--amber);">‚ú¶ Generate</strong>
                        </div>
                        <div id="preview-txt" style="display: none;"></div>
                        <div class="gen-overlay" id="gen-overlay">
                            <div class="gen-spinner"></div>
                            <div class="gen-label">AI is writing your message...</div>
                        </div>
                    </div>
                    <div style="font-size: 10px; color: var(--muted2); font-family: var(--mono); text-align: right; margin-top: 6px;" id="gen-ts"></div>

                    <!-- Image Widget Section -->
                    <div class="widget-section" style="margin-top: 14px;">
                        <div class="widget-toggle" onclick="toggleWidget()">
                            <span style="font-size: 12px; font-weight: 600;">üñº Match Image Widget</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); loadWidget()" id="widget-load-btn" style="display: none;">Load</button>
                                <span id="widget-chevron" style="color: var(--muted2);">‚ñº</span>
                            </div>
                        </div>
                        <div id="widget-body" style="display: none;">
                            <div id="widget-loading" style="text-align: center; padding: 20px; display: none;">
                                <div class="gen-spinner" style="width: 24px; height: 24px; margin: 0 auto 10px;"></div>
                                <div style="font-size: 12px; color: var(--muted2);">Loading widget data...</div>
                            </div>
                            <div id="widget-render"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Send To Card -->
            <div class="card">
                <div class="card-hdr">
                    <div class="card-title">Send To</div>
                </div>
                <div class="card-body">
                    <div id="ch-list">
                        <div class="loading">No channels. Add in Settings.</div>
                    </div>
                    <div style="margin-top: 12px;">
                        <button class="btn btn-cyan btn-full" onclick="sendAll()">
                            üì§ Send to Telegram
                        </button>
                    </div>
                    <div style="margin-top: 8px; font-size: 11px; color: var(--muted2); text-align: center;">
                        Or <button onclick="copyMsg()" style="background: none; border: none; color: var(--cyan); cursor: pointer; font-size: 11px;">copy</button> and paste into WhatsApp
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast"></div>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        const LEAGUES = [
            {id: 39, name: 'Premier League', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø'},
            {id: 140, name: 'La Liga', flag: 'üá™üá∏'},
            {id: 135, name: 'Serie A', flag: 'üáÆüáπ'},
            {id: 78, name: 'Bundesliga', flag: 'üá©üá™'},
            {id: 61, name: 'Ligue 1', flag: 'üá´üá∑'},
            {id: 2, name: 'Champions League', flag: '‚≠ê'},
            {id: 3, name: 'Europa League', flag: 'üåç'},
            {id: 848, name: 'Conference League', flag: 'üåê'},
            {id: 94, name: 'Primeira Liga', flag: 'üáµüáπ'},
            {id: 88, name: 'Eredivisie', flag: 'üá≥üá±'},
            {id: 144, name: 'Jupiler League', flag: 'üáßüá™'},
            {id: 203, name: 'S√ºper Lig', flag: 'üáπüá∑'},
            {id: 253, name: 'MLS', flag: 'üá∫üá∏'},
            {id: 262, name: 'Liga MX', flag: 'üá≤üáΩ'},
            {id: 71, name: 'Brasileir√£o', flag: 'üáßüá∑'},
            {id: 128, name: 'Liga Argentina', flag: 'üá¶üá∑'},
            {id: 98, name: 'J1 League', flag: 'üáØüáµ'},
            {id: 307, name: 'Saudi League', flag: 'üá∏üá¶'},
            {id: 480, name: 'Nations League', flag: '‚öΩ'}
        ];

        // ============================================================
        // STATE
        // ============================================================
        let sessionToken = localStorage.getItem('session_token');
        let userStatus = null;
        let allMatches = [];
        let selectedMatch = null;
        let generatedMsg = '';

        // ============================================================
        // INITIALIZATION
        // ============================================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            if (!sessionToken) {
                window.location.href = '/activate.html';
                return;
            }
            
            // Verify session with server
            try {
                const res = await fetch('/api/auth/check', {
                    headers: { 'session': sessionToken }
                });
                
                if (!res.ok) {
                    localStorage.removeItem('session_token');
                    window.location.href = '/activate.html';
                    return;
                }
                
                const data = await res.json();
                userStatus = data;
                
                // Update UI
                updateStatusBadge(data.status);
                updateQuotaDisplay(data.used_today, data.quota);
                
                // Load initial data
                populateLeagues();
                loadChannels();
                loadMatches();
                
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('session_token');
                window.location.href = '/activate.html';
            }
        });

        // ============================================================
        // AUTH FUNCTIONS
        // ============================================================
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'session': sessionToken }
                });
            } catch (e) {
                // Ignore errors
            }
            
            localStorage.removeItem('session_token');
            window.location.href = '/activate.html';
        }

        function updateStatusBadge(status) {
            const badge = document.getElementById('status-badge');
            const emoji = status === 'active' ? '‚úÖ' : status === 'trial' ? '‚è≥' : '‚ö™';
            
            badge.className = `status-badge badge-${status === 'active' ? 'premium' : 'trial'}`;
            badge.innerHTML = `${emoji} ${status.toUpperCase()}`;
        }

        function updateQuotaDisplay(used, quota) {
            const remaining = Math.max(quota - used, 0);
            document.getElementById('quota-txt').textContent = `${remaining} left`;
            
            const percentage = (remaining / quota) * 100;
            const fill = document.getElementById('quota-fill');
            fill.style.width = `${Math.max(percentage, 0)}%`;
            
            // Color based on remaining
            if (percentage < 20) {
                fill.style.background = 'var(--red)';
            } else if (percentage < 50) {
                fill.style.background = 'var(--amber)';
            } else {
                fill.style.background = 'var(--green)';
            }
        }

        // ============================================================
        // FETCH WRAPPER (includes auth)
        // ============================================================
        async function authFetch(url, options = {}) {
            options.headers = {
                ...(options.headers || {}),
                'session': sessionToken
            };
            
            const response = await fetch(url, options);
            
            // Handle auth errors
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('session_token');
                window.location.href = '/activate.html';
                throw new Error('Session expired');
            }
            
            return response;
        }

        // ============================================================
        // UI FUNCTIONS
        // ============================================================
        function populateLeagues() {
            const sel = document.getElementById('league-sel');
            sel.innerHTML = '<option value="">All Top-25 Leagues</option>';
            
            LEAGUES.sort((a, b) => a.name.localeCompare(b.name)).forEach(l => {
                sel.innerHTML += `<option value="${l.id}">${l.flag} ${l.name}</option>`;
            });
        }

        function toggleType() {
            const type = document.getElementById('msg-type').value;
            const isMatch = ['live', 'preview'].includes(type);
            const isLeague = ['standings', 'digest'].includes(type);
            
            document.getElementById('match-section').style.display = isMatch ? 'block' : 'none';
            document.getElementById('league-section').style.display = isLeague ? 'block' : 'none';
        }

        // ============================================================
        // MATCHES
        // ============================================================
        async function loadMatches() {
            const listEl = document.getElementById('match-list');
            listEl.innerHTML = '<div class="loading">‚è≥ Loading matches...</div>';
            
            try {
                const [liveRes, todayRes] = await Promise.all([
                    authFetch('/api/matches/live'),
                    authFetch('/api/matches/today')
                ]);
                
                const liveData = await liveRes.json();
                const todayData = await todayRes.json();
                
                const live = liveData.matches || [];
                const today = todayData.matches || [];
                
                const liveSet = new Set(live.map(m => m.fixture.id));
                allMatches = [...live, ...today.filter(m => !liveSet.has(m.fixture.id))];
                
                if (!allMatches.length) {
                    listEl.innerHTML = '<div class="loading">No top-25 fixtures today</div>';
                    return;
                }
                
                listEl.innerHTML = allMatches.map(m => {
                    const isLive = liveSet.has(m.fixture.id);
                    const score = m.goals.home !== null ? `${m.goals.home}‚Äì${m.goals.away}` : 'vs';
                    const time = new Date(m.fixture.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="match-item" onclick="selectMatch(${m.fixture.id})" id="mi-${m.fixture.id}">
                            <div class="mi-teams">
                                <span>${m.teams.home.name}</span>
                                <span class="mi-score">${score}</span>
                                <span>${m.teams.away.name}</span>
                            </div>
                            <div class="mi-meta">
                                ${isLive ? `<span class="live-dot"></span><span style="color: var(--amber);">${m.fixture.status.elapsed}'</span>` : `<span>${time}</span>`}
                                <span>¬∑</span>
                                <span>${m.league.name}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Select first match by default
                if (allMatches.length) {
                    selectMatch(allMatches[0].fixture.id);
                }
                
            } catch (error) {
                console.error('Error loading matches:', error);
                listEl.innerHTML = '<div class="error">Failed to load matches</div>';
            }
        }

        function selectMatch(id) {
            document.querySelectorAll('.match-item').forEach(el => el.classList.remove('sel'));
            const el = document.getElementById(`mi-${id}`);
            if (el) {
                el.classList.add('sel');
                selectedMatch = allMatches.find(m => m.fixture.id === id) || null;
                
                // Show widget load button
                document.getElementById('widget-load-btn').style.display = 'inline-flex';
            }
        }

        // ============================================================
        // AI GENERATION
        // ============================================================
        async function generate() {
            const type = document.getElementById('msg-type').value;
            
            // Validate selections
            if (['live', 'preview'].includes(type) && !selectedMatch) {
                toast('Please select a match first', 'error');
                return;
            }
            
            if (type === 'standings' && !document.getElementById('league-sel').value) {
                toast('Please select a league', 'error');
                return;
            }
            
            // Show loading state
            const btn = document.getElementById('gen-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="gen-spinner" style="width: 16px; height: 16px; margin-right: 8px;"></span> Generating...';
            btn.disabled = true;
            
            document.getElementById('preview-ph').style.display = 'none';
            document.getElementById('preview-txt').style.display = 'none';
            document.getElementById('gen-overlay').style.display = 'flex';
            
            try {
                // Build payload
                const payload = {
                    message_type: type,
                    tone: document.getElementById('tone').value,
                    length: document.getElementById('length').value,
                    include_stats: document.getElementById('inc-stats').checked,
                    include_players: document.getElementById('inc-players').checked
                };
                
                // Add affiliate link if exists
                const aff = JSON.parse(localStorage.getItem('ap_affiliate') || '{}');
                if (aff.url) {
                    payload.affiliate_line = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n${aff.label || 'üîó Join us'} ‚Üí ${aff.url}`;
                }
                
                // Add match data
                if (type === 'live' || type === 'preview') {
                    payload.match_data = selectedMatch;
                    
                    // Fetch additional data
                    if (type === 'live' && payload.include_stats) {
                        const statsRes = await authFetch(`/api/matches/stats?fixture=${selectedMatch.fixture.id}`);
                        const statsData = await statsRes.json();
                        if (statsData.stats) payload.stats_data = statsData.stats;
                    }
                    
                    if (type === 'preview') {
                        const h2hRes = await authFetch(`/api/matches/h2h?h2h=${selectedMatch.teams.home.id}-${selectedMatch.teams.away.id}&last=5`);
                        const h2hData = await h2hRes.json();
                        if (h2hData.fixtures) payload.h2h_data = h2hData.fixtures;
                    }
                }
                
                // Add standings data
                if (type === 'standings') {
                    const lid = document.getElementById('league-sel').value;
                    const season = document.getElementById('season-sel').value;
                    const standingsRes = await authFetch(`/api/standings?league=${lid}&season=${season}`);
                    const standingsData = await standingsRes.json();
                    
                    if (standingsData.standings?.[0]?.league?.standings?.[0]) {
                        payload.standings_data = standingsData.standings[0].league.standings[0];
                        payload.league_name = standingsData.standings[0].league.name;
                    }
                }
                
                // Add fixtures digest
                if (type === 'digest') {
                    const lid = document.getElementById('league-sel').value;
                    const url = lid ? `/api/matches/today?league=${lid}` : '/api/matches/today';
                    const fixturesRes = await authFetch(url);
                    const fixturesData = await fixturesRes.json();
                    payload.fixtures_data = fixturesData.matches || [];
                }
                
                // Generate message
                const genRes = await authFetch('/api/ai/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const genData = await genRes.json();
                
                // Display message
                generatedMsg = genData.message;
                document.getElementById('preview-txt').textContent = generatedMsg;
                document.getElementById('preview-txt').style.display = 'block';
                document.getElementById('gen-ts').textContent = `Generated ${new Date().toLocaleTimeString()}`;
                
                // Update quota display
                if (userStatus) {
                    userStatus.used_today++;
                    updateQuotaDisplay(userStatus.used_today, userStatus.quota);
                }
                
                toast('‚ú® Message generated successfully!');
                
            } catch (error) {
                console.error('Generation error:', error);
                toast('Error: ' + error.message, 'error');
                document.getElementById('preview-ph').style.display = 'block';
                
            } finally {
                document.getElementById('gen-overlay').style.display = 'none';
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ============================================================
        // WIDGET
        // ============================================================
        let widgetOpen = false;
        
        function toggleWidget() {
            widgetOpen = !widgetOpen;
            document.getElementById('widget-body').style.display = widgetOpen ? 'block' : 'none';
            document.getElementById('widget-chevron').textContent = widgetOpen ? '‚ñ≤' : '‚ñº';
        }
        
        async function loadWidget() {
            if (!selectedMatch) {
                toast('Select a match first', 'error');
                return;
            }
            
            const body = document.getElementById('widget-body');
            const loading = document.getElementById('widget-loading');
            
            if (!widgetOpen) toggleWidget();
            
            loading.style.display = 'block';
            document.getElementById('widget-render').innerHTML = '';
            
            try {
                const res = await authFetch(`/api/widget/match?fixture=${selectedMatch.fixture.id}`);
                const widgetData = await res.json();
                
                renderWidget(widgetData);
                
            } catch (error) {
                document.getElementById('widget-render').innerHTML = 
                    `<div class="error">Failed to load widget: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        function renderWidget(w) {
            const statusStr = w.status.short === 'FT' ? 'Full Time' :
                             w.status.short === 'HT' ? 'Half Time' :
                             w.status.elapsed ? `${w.status.elapsed}'` : w.status.long || '';
            
            // Group events
            const goals = w.events.filter(e => e.type === 'Goal');
            
            const evHtml = w.events.length ? `
                <div class="widget-events">
                    ${w.events.map(e => {
                        const icon = e.type === 'Goal' ? '‚öΩ' : 'üü®';
                        const isHome = e.team_name === w.home.name;
                        const time = e.minute + (e.extra_minute ? `+${e.extra_minute}` : '');
                        
                        return `
                            <div class="widget-event">
                                <span class="widget-event-min">${time}'</span>
                                <span class="widget-event-icon">${icon}</span>
                                <span style="flex: 1; text-align: ${isHome ? 'left' : 'right'};">${e.player || ''}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            ` : '';
            
            document.getElementById('widget-render').innerHTML = `
                <div class="match-widget" id="widget-card">
                    <div class="widget-league">
                        <span class="widget-league-name">${w.league.name}</span>
                    </div>
                    <div class="widget-teams">
                        <div class="widget-team">
                            <div class="widget-team-name">${w.home.name}</div>
                        </div>
                        <div class="widget-score-box">
                            <div class="widget-score">${w.home.score ?? '‚Äì'}‚Äì${w.away.score ?? '‚Äì'}</div>
                            <div class="widget-status">${statusStr}</div>
                        </div>
                        <div class="widget-team">
                            <div class="widget-team-name">${w.away.name}</div>
                        </div>
                    </div>
                    ${evHtml}
                </div>
            `;
        }

        // ============================================================
        // CHANNELS
        // ============================================================
        function loadChannels() {
            const channels = JSON.parse(localStorage.getItem('ap_channels') || '[]');
            const el = document.getElementById('ch-list');
            
            if (!channels.length) {
                el.innerHTML = '<div class="loading">No channels. <a href="index.html" style="color: var(--cyan);">Add in Settings ‚Üí</a></div>';
                return;
            }
            
            el.innerHTML = channels.map((ch, i) => `
                <div class="ch-row">
                    <label>
                        <input type="checkbox" class="ch-cb" value="${i}" checked>
                        üì¢ ${ch.name}
                        <span style="font-family: var(--mono); font-size: 10px; color: var(--muted2); margin-left: 8px;">${ch.chatId}</span>
                    </label>
                </div>
            `).join('');
        }

        // ============================================================
        // SEND & COPY
        // ============================================================
        async function sendAll() {
            if (!generatedMsg) {
                toast('Generate a message first', 'error');
                return;
            }
            
            const token = localStorage.getItem('ap_botToken');
            if (!token) {
                toast('No bot token. Add in Settings.', 'error');
                return;
            }
            
            const channels = JSON.parse(localStorage.getItem('ap_channels') || '[]');
            const selected = [...document.querySelectorAll('.ch-cb:checked')]
                .map(cb => channels[parseInt(cb.value)])
                .filter(Boolean);
            
            if (!selected.length) {
                toast('Select at least one channel', 'error');
                return;
            }
            
            let sent = 0;
            for (const ch of selected) {
                try {
                    const res = await fetch('/api/telegram/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: ch.chatId,
                            text: generatedMsg,
                            bot_token: token
                        })
                    });
                    
                    const data = await res.json();
                    if (data.ok) sent++;
                    
                } catch (e) {
                    console.error('Send error:', e);
                }
            }
            
            if (sent > 0) {
                // Save to history
                const posts = JSON.parse(localStorage.getItem('ap_posts') || '[]');
                posts.unshift({
                    id: Date.now(),
                    preview: generatedMsg.substring(0, 80),
                    platform: 'Telegram',
                    type: 'AI',
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('ap_posts', JSON.stringify(posts.slice(0, 50)));
                
                toast(`‚úÖ Sent to ${sent} channel(s)`);
            } else {
                toast('Send failed. Check bot token.', 'error');
            }
        }
        
        function copyMsg() {
            if (!generatedMsg) {
                toast('Nothing to copy yet', 'error');
                return;
            }
            
            navigator.clipboard.writeText(generatedMsg)
                .then(() => toast('‚úì Copied to clipboard!'))
                .catch(() => toast('Copy failed', 'error'));
        }

        // ============================================================
        // TOAST
        // ============================================================
        function toast(message, type = 'success') {
            const el = document.getElementById('toast');
            el.textContent = message;
            el.style.background = type === 'error' ? '#ef4444' : 
                                 type === 'info' ? '#3b82f6' : '#10b981';
            el.style.display = 'block';
            
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>