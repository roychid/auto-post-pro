<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AutoPost Pro ‚Äî Football Command Center</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#07080f;--s1:#0b0d16;--s2:#0f1120;--s3:#141728;--s4:#1a1e30;--s5:#20243a;
  --rim:rgba(255,255,255,.055);--rim2:rgba(255,255,255,.10);--rim3:rgba(255,255,255,.18);
  --volt:#c8ff00;--volt2:#deff55;--vfog:rgba(200,255,0,.09);--vglow:rgba(200,255,0,.22);
  --red:#ff4545;--redfog:rgba(255,69,69,.10);
  --sky:#3cc8ff;--skyfog:rgba(60,200,255,.09);
  --amber:#ffb020;--ambfog:rgba(255,176,32,.09);
  --green:#3effa0;--grnfog:rgba(62,255,160,.09);
  --purple:#b87fff;--prpfog:rgba(184,127,255,.09);
  --white:#edf0ff;--grey:#7e879e;--dim:#3a4058;
  --display:'Bebas Neue',sans-serif;--body:'DM Sans',sans-serif;--mono:'DM Mono',monospace;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:var(--body);background:var(--bg);color:var(--white);display:flex;flex-direction:column;}
body::after{content:'';position:fixed;inset:0;z-index:9999;pointer-events:none;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
  background-size:220px;}

@keyframes spin{to{transform:rotate(360deg)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
@keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pop{0%{transform:scale(.85);opacity:0}70%{transform:scale(1.04)}100%{transform:scale(1);opacity:1}}
@keyframes glow-pulse{0%,100%{box-shadow:0 0 20px var(--vglow)}50%{box-shadow:0 0 40px rgba(200,255,0,.35)}}
@keyframes shimmer{0%{background-position:200% center}100%{background-position:-200% center}}
@keyframes progress{from{width:0}to{width:var(--w,100%)}}
@keyframes msg-reveal{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse-ring{0%{transform:scale(.9);opacity:.8}100%{transform:scale(1.3);opacity:0}}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{height:52px;min-height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:rgba(7,8,15,.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--rim);flex-shrink:0;z-index:200;position:relative;}
.logo{display:flex;align-items:center;gap:10px;font-family:var(--display);font-size:20px;letter-spacing:.06em;color:var(--white);text-decoration:none;cursor:pointer;}
.logo-mark{width:28px;height:28px;background:var(--volt);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;animation:glow-pulse 3s ease-in-out infinite;}
.logo span{color:var(--volt);}
.ticker-mini{display:flex;align-items:center;height:28px;background:var(--s2);border:1px solid var(--rim);border-radius:6px;overflow:hidden;max-width:360px;}
.tm-label{padding:0 10px;font-family:var(--mono);font-size:9px;color:var(--red);font-weight:600;letter-spacing:.1em;border-right:1px solid var(--rim);white-space:nowrap;height:100%;display:flex;align-items:center;gap:5px;}
.tm-label .dot{width:5px;height:5px;border-radius:50%;background:var(--red);animation:blink .8s infinite;}
.tm-scroll{overflow:hidden;flex:1;}
.tm-inner{display:flex;animation:ticker 28s linear infinite;white-space:nowrap;}
.tm-inner:hover{animation-play-state:paused;}
.tm-item{padding:0 16px;font-family:var(--mono);font-size:10px;color:var(--grey);border-right:1px solid var(--rim);height:28px;display:flex;align-items:center;gap:6px;}
.tm-item .sc{color:var(--volt);font-weight:600;}
.hdr-right{display:flex;align-items:center;gap:8px;}
.hdr-btn{background:none;border:1px solid var(--rim);color:var(--dim);padding:4px 10px;border-radius:5px;font-size:11px;cursor:pointer;transition:.15s;font-family:var(--body);}
.hdr-btn:hover{border-color:var(--volt);color:var(--volt);}
.notif-btn{position:relative;background:none;border:1px solid var(--rim);color:var(--dim);width:28px;height:28px;border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:.15s;}
.notif-btn:hover{border-color:var(--amber);color:var(--amber);}
.notif-btn.on{border-color:var(--amber);color:var(--amber);background:var(--ambfog);}
.notif-dot{position:absolute;top:-2px;right:-2px;width:7px;height:7px;border-radius:50%;background:var(--red);display:none;}
.notif-btn.has-notif .notif-dot{display:block;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app{flex:1;display:grid;grid-template-columns:284px 1fr 280px;overflow:hidden;min-height:0;}
.col{display:flex;flex-direction:column;overflow:hidden;}
.col-l{border-right:1px solid var(--rim);}
.col-m{border-right:1px solid var(--rim);}
.scrollable{overflow-y:auto;flex:1;}
.scrollable::-webkit-scrollbar{width:3px;}
.scrollable::-webkit-scrollbar-thumb{background:var(--s4);border-radius:2px;}

/* ‚îÄ‚îÄ SEC HEADERS ‚îÄ‚îÄ */
.sec{display:flex;align-items:center;justify-content:space-between;padding:10px 16px 8px;border-bottom:1px solid var(--rim);flex-shrink:0;}
.sec-title{font-family:var(--mono);font-size:9px;font-weight:500;text-transform:uppercase;letter-spacing:.12em;color:var(--dim);display:flex;align-items:center;gap:6px;}
.sec-title::before{content:'';width:8px;height:2px;border-radius:1px;background:var(--volt);}
.sec-actions{display:flex;gap:5px;align-items:center;}
.mb{background:none;border:1px solid var(--rim);color:var(--dim);padding:2px 8px;border-radius:4px;font-size:10px;font-family:var(--mono);cursor:pointer;transition:.12s;white-space:nowrap;}
.mb:hover{border-color:var(--volt);color:var(--volt);}
.mb.sky:hover{border-color:var(--sky);color:var(--sky);}
.mb.red:hover{border-color:var(--red);color:var(--red);}
.mb.on{border-color:var(--volt);color:var(--volt);background:var(--vfog);}
.mb.amber{border-color:var(--amber);color:var(--amber);}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.field{padding:0 16px 10px;}
.lbl{display:block;font-family:var(--mono);font-size:9px;font-weight:500;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:5px;}
.sel,.inp{width:100%;background:var(--s2);border:1px solid var(--rim2);border-radius:6px;color:var(--white);font-size:12px;padding:7px 10px;outline:none;font-family:var(--body);transition:.15s;appearance:none;cursor:pointer;}
.sel:focus,.inp:focus{border-color:var(--volt);box-shadow:0 0 0 2px var(--vfog);}
.sel-wrap{position:relative;}
.sel-wrap::after{content:'‚ñæ';position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--dim);font-size:11px;}
.textarea{width:100%;background:var(--s2);border:1px solid var(--rim2);border-radius:6px;color:var(--white);font-size:12px;padding:8px 10px;outline:none;font-family:var(--mono);resize:vertical;min-height:70px;transition:.15s;line-height:1.6;}
.textarea:focus{border-color:var(--volt);}
.tog{display:flex;align-items:center;justify-content:space-between;padding:7px 16px;border-bottom:1px solid var(--rim);}
.tog-info{flex:1;}
.tog-name{font-size:12px;color:var(--white);}
.tog-sub{font-size:10px;color:var(--dim);font-family:var(--mono);margin-top:1px;}
.sw{position:relative;width:30px;height:17px;flex-shrink:0;margin-left:10px;}
.sw input{opacity:0;width:0;height:0;}
.sw-track{position:absolute;inset:0;cursor:pointer;background:var(--s4);border-radius:17px;border:1px solid var(--rim2);transition:.2s;}
.sw-track::before{content:'';position:absolute;width:9px;height:9px;border-radius:50%;left:3px;top:3px;background:var(--dim);transition:.2s;}
.sw input:checked+.sw-track{background:var(--vfog);border-color:rgba(200,255,0,.35);}
.sw input:checked+.sw-track::before{transform:translateX(13px);background:var(--volt);box-shadow:0 0 6px var(--volt);}

/* ‚îÄ‚îÄ LEFT COL ‚îÄ‚îÄ */
.type-tabs{display:flex;border-bottom:1px solid var(--rim);padding:0 4px;gap:0;flex-shrink:0;overflow-x:auto;}
.type-tabs::-webkit-scrollbar{display:none;}
.ttab{padding:8px 9px;font-size:11px;font-weight:500;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;transition:.12s;white-space:nowrap;}
.ttab:hover{color:var(--grey);}
.ttab.on{color:var(--volt);border-bottom-color:var(--volt);}
.match-row{padding:10px 16px;border-bottom:1px solid var(--rim);cursor:pointer;transition:background .1s;position:relative;}
.match-row:hover{background:var(--s2);}
.match-row.sel{background:var(--vfog);}
.match-row.sel::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--volt);}
.mr-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:3px;gap:6px;}
.mr-home,.mr-away{font-size:12px;font-weight:500;color:var(--white);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mr-away{text-align:right;}
.mr-score{font-family:var(--mono);font-size:11px;color:var(--volt);background:var(--vfog);padding:1px 7px;border-radius:3px;font-weight:600;white-space:nowrap;flex-shrink:0;}
.mr-bot{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:9px;color:var(--dim);flex-wrap:wrap;}
.tag-live{display:inline-flex;align-items:center;gap:3px;padding:1px 6px;border-radius:3px;background:var(--redfog);color:var(--red);font-size:8px;font-weight:700;letter-spacing:.04em;}
.tag-live .p{width:4px;height:4px;border-radius:50%;background:var(--red);animation:blink .8s infinite;}
.tag-ft{display:inline-flex;padding:1px 6px;border-radius:3px;background:var(--s3);color:var(--dim);font-size:8px;letter-spacing:.04em;}
.tag-sch{display:inline-flex;padding:1px 6px;border-radius:3px;background:var(--skyfog);color:var(--sky);font-size:8px;letter-spacing:.04em;}
.league-hdr{padding:5px 16px;background:var(--s1);border-bottom:1px solid var(--rim);font-family:var(--mono);font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;display:flex;align-items:center;gap:6px;}
.search-wrap{padding:8px 16px;border-bottom:1px solid var(--rim);flex-shrink:0;display:flex;gap:6px;}
.search-inp{flex:1;background:var(--s2);border:1px solid var(--rim);border-radius:5px;padding:6px 10px;font-size:12px;color:var(--white);outline:none;font-family:var(--body);}
.search-inp:focus{border-color:var(--volt);}
.search-inp::placeholder{color:var(--dim);}
.league-filter{background:var(--s2);border:1px solid var(--rim);border-radius:5px;padding:6px 8px;font-size:11px;color:var(--white);outline:none;font-family:var(--mono);appearance:none;cursor:pointer;}
.league-filter:focus{border-color:var(--volt);}
.filter-row{display:flex;gap:4px;padding:6px 16px;border-bottom:1px solid var(--rim);flex-shrink:0;flex-wrap:wrap;}
.tpl-row{display:flex;flex-wrap:wrap;gap:5px;padding:10px 16px;border-bottom:1px solid var(--rim);}
.tpl-chip{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;cursor:pointer;border:1px solid var(--rim2);background:var(--s2);color:var(--grey);transition:.12s;white-space:nowrap;}
.tpl-chip:hover{border-color:var(--volt);color:var(--volt);background:var(--vfog);}
.tpl-chip.on{border-color:var(--volt);color:var(--volt);background:var(--vfog);}
.gen-wrap{padding:10px 16px;border-top:1px solid var(--rim);flex-shrink:0;}
.gen-btn{width:100%;padding:11px;background:linear-gradient(135deg,var(--volt),var(--volt2));border:none;border-radius:7px;font-family:var(--display);font-size:17px;letter-spacing:.06em;color:var(--bg);cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 3px 20px var(--vfog);position:relative;overflow:hidden;}
.gen-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(105deg,transparent 35%,rgba(255,255,255,.22) 50%,transparent 65%);background-size:200% 100%;animation:shimmer 2.5s infinite;}
.gen-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 28px var(--vglow);}
.gen-btn:disabled{opacity:.45;cursor:not-allowed;}
.gen-btn kbd{font-family:var(--mono);font-size:10px;background:rgba(0,0,0,.2);border-radius:3px;padding:1px 5px;}

/* ‚îÄ‚îÄ MID TABS ‚îÄ‚îÄ */
.mid-tabs{display:flex;border-bottom:1px solid var(--rim);padding:0 4px;flex-shrink:0;overflow-x:auto;}
.mid-tabs::-webkit-scrollbar{display:none;}
.mtab{padding:9px 11px;font-size:11px;font-weight:500;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;transition:.12s;white-space:nowrap;}
.mtab:hover{color:var(--grey);}
.mtab.on{color:var(--volt);border-bottom-color:var(--volt);}

/* ‚îÄ‚îÄ MESSAGE ‚îÄ‚îÄ */
#view-message{display:flex;flex-direction:column;height:100%;}
.msg-actions{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;border-bottom:1px solid var(--rim);flex-shrink:0;flex-wrap:wrap;gap:6px;}
.ma-left{display:flex;gap:5px;flex-wrap:wrap;}
.ma-right{display:flex;align-items:center;gap:10px;font-family:var(--mono);font-size:10px;color:var(--dim);}
.char-counter{font-family:var(--mono);font-size:10px;display:flex;flex-direction:column;align-items:flex-end;gap:2px;}
.char-limit{font-size:9px;padding:1px 5px;border-radius:3px;font-weight:600;}
.char-ok{background:var(--grnfog);color:var(--green);}
.char-warn{background:var(--ambfog);color:var(--amber);}
.char-over{background:var(--redfog);color:var(--red);}
.action-btn{display:inline-flex;align-items:center;gap:5px;padding:5px 11px;border-radius:5px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--rim2);background:var(--s2);color:var(--grey);transition:.12s;font-family:var(--body);}
.action-btn:hover{color:var(--white);border-color:var(--rim3);background:var(--s3);}
.action-btn.primary{background:var(--skyfog);color:var(--sky);border-color:rgba(60,200,255,.25);}
.action-btn.primary:hover{background:rgba(60,200,255,.15);}
.action-btn.danger{background:var(--redfog);color:var(--red);border-color:rgba(255,69,69,.25);}
.action-btn.volt{background:var(--vfog);color:var(--volt);border-color:rgba(200,255,0,.25);}
.msg-body{flex:1;overflow-y:auto;padding:20px;position:relative;font-family:var(--mono);font-size:12.5px;line-height:1.85;color:var(--white);white-space:pre-wrap;word-break:break-word;}
.msg-body::-webkit-scrollbar{width:3px;}
.msg-body::-webkit-scrollbar-thumb{background:var(--s4);}
.msg-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:10px;padding:24px;}
.mp-icon{font-size:34px;opacity:.18;}
.mp-text{font-size:13px;color:var(--dim);font-family:var(--body);line-height:1.6;}
.mp-text strong{color:var(--volt);}
.mp-shortcuts{display:flex;flex-direction:column;gap:4px;margin-top:8px;}
.mp-sc-item{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--dim);font-family:var(--mono);}
.mp-sc-item kbd{background:var(--s3);border:1px solid var(--rim2);border-radius:3px;padding:1px 6px;font-size:9px;color:var(--grey);}
.msg-generated{animation:msg-reveal .3s ease;}
.gen-overlay{position:absolute;inset:0;background:rgba(7,8,15,.94);display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;backdrop-filter:blur(4px);z-index:10;}
.ring-loader{width:40px;height:40px;border:2px solid var(--s4);border-top-color:var(--volt);border-right-color:var(--volt2);border-radius:50%;animation:spin .75s cubic-bezier(.5,.1,.5,.9) infinite;}
.gen-status-txt{font-family:var(--mono);font-size:11px;color:var(--grey);}
.msg-footer{padding:8px 16px;border-top:1px solid var(--rim);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;font-family:var(--mono);font-size:10px;color:var(--dim);}
.copy-bar{margin:0 16px 10px;padding:8px 14px;background:var(--vfog);border:1px dashed rgba(200,255,0,.25);border-radius:6px;font-family:var(--mono);font-size:10px;color:var(--volt);cursor:pointer;display:none;align-items:center;justify-content:space-between;}
.copy-bar:hover{background:rgba(200,255,0,.12);}

/* Platform limits bar */
.platform-limits{display:flex;gap:6px;padding:6px 16px;border-bottom:1px solid var(--rim);flex-shrink:0;overflow-x:auto;}
.plat-pill{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-family:var(--mono);font-size:9px;border:1px solid var(--rim);background:var(--s2);white-space:nowrap;cursor:default;}
.plat-name{color:var(--dim);}
.plat-count{font-weight:600;}

/* Hashtag strip */
.hashtag-strip{padding:8px 16px;border-bottom:1px solid var(--rim);flex-shrink:0;display:none;}
.hashtag-label{font-family:var(--mono);font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;}
.hashtag-tags{display:flex;flex-wrap:wrap;gap:4px;}
.hashtag-tag{padding:3px 9px;border-radius:20px;font-size:10px;font-family:var(--mono);background:var(--s3);border:1px solid var(--rim);color:var(--grey);cursor:pointer;transition:.12s;}
.hashtag-tag:hover{border-color:var(--volt);color:var(--volt);}
.hashtag-tag.added{border-color:var(--volt);color:var(--volt);background:var(--vfog);}

/* Send panel */
.send-panel{border-top:1px solid var(--rim);padding:12px 16px;flex-shrink:0;}
.ch-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--rim);}
.ch-row:last-child{border-bottom:none;}
.ch-row label{display:flex;align-items:center;gap:8px;flex:1;cursor:pointer;font-size:12px;color:var(--grey);}
.ch-row input[type=checkbox]{accent-color:var(--volt);width:13px;height:13px;cursor:pointer;}
.ch-cid{font-family:var(--mono);font-size:9px;color:var(--dim);margin-left:auto;}
.send-btn{width:100%;margin-top:10px;padding:11px;background:var(--skyfog);border:1px solid rgba(60,200,255,.25);border-radius:7px;color:var(--sky);font-family:var(--display);font-size:16px;letter-spacing:.06em;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:8px;}
.send-btn:hover{background:rgba(60,200,255,.15);transform:translateY(-1px);}
.send-btn:disabled{opacity:.45;cursor:not-allowed;}
.send-btns-row{display:flex;gap:6px;margin-top:8px;}
.send-sub{flex:1;padding:8px;background:var(--s2);border:1px solid var(--rim2);border-radius:6px;font-size:11px;font-weight:500;color:var(--grey);cursor:pointer;transition:.15s;display:flex;align-items:center;justify-content:center;gap:5px;font-family:var(--body);text-decoration:none;}
.send-sub:hover{color:var(--white);border-color:var(--rim3);}
.send-sub.wa:hover{color:#25d366;border-color:#25d366;}
.send-sub.x:hover{color:var(--white);border-color:var(--white);}

/* ‚îÄ‚îÄ EVENTS VIEW ‚îÄ‚îÄ */
#view-events{display:none;flex-direction:column;height:100%;}
.ev-match-bar{padding:10px 16px;border-bottom:1px solid var(--rim);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.emb-score{font-family:var(--display);font-size:22px;letter-spacing:.04em;color:var(--volt);}
.emb-info{font-family:var(--mono);font-size:10px;color:var(--dim);}
.ev-item{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--rim);transition:background .1s;}
.ev-item:hover{background:var(--s2);}
.ev-min{font-family:var(--mono);font-size:10px;color:var(--volt);min-width:28px;font-weight:500;}
.ev-icon{font-size:16px;flex-shrink:0;}
.ev-detail{flex:1;}
.ev-player{font-size:12px;font-weight:600;color:var(--white);}
.ev-team{font-size:10px;color:var(--dim);font-family:var(--mono);}
.ev-post-btn{opacity:0;transition:.1s;}
.ev-item:hover .ev-post-btn{opacity:1;}
.ev-bottom{padding:12px 16px;border-top:1px solid var(--rim);flex-shrink:0;}

/* ‚îÄ‚îÄ FIXTURES VIEW ‚îÄ‚îÄ */
#view-fixtures{display:none;flex-direction:column;height:100%;}
.fix-toolbar{padding:8px 16px;border-bottom:1px solid var(--rim);display:flex;gap:8px;flex-shrink:0;align-items:center;}
.date-inp{background:var(--s2);border:1px solid var(--rim);border-radius:5px;padding:5px 8px;font-size:11px;color:var(--white);outline:none;font-family:var(--mono);}
.date-inp:focus{border-color:var(--volt);}
.fix-item{display:flex;align-items:center;padding:10px 16px;border-bottom:1px solid var(--rim);gap:8px;transition:background .1s;}
.fix-item:hover{background:var(--s2);}
.fix-time{font-family:var(--mono);font-size:10px;color:var(--dim);min-width:44px;}
.fix-teams{flex:1;font-size:12px;font-weight:500;}
.fix-teams .sep{color:var(--dim);font-family:var(--mono);font-size:10px;margin:0 5px;}
.fix-score{font-family:var(--mono);font-size:11px;color:var(--volt);min-width:34px;text-align:center;}
.fix-acts{display:flex;gap:4px;opacity:0;transition:.1s;}
.fix-item:hover .fix-acts{opacity:1;}

/* ‚îÄ‚îÄ STATS VIEW ‚îÄ‚îÄ */
#view-stats{display:none;flex-direction:column;height:100%;}
.stats-header{padding:14px 16px;border-bottom:1px solid var(--rim);display:grid;grid-template-columns:1fr auto 1fr;gap:8px;text-align:center;flex-shrink:0;}
.sh-team{font-size:13px;font-weight:600;}
.sh-score{font-family:var(--display);font-size:28px;color:var(--volt);letter-spacing:.04em;}
.sh-status{font-family:var(--mono);font-size:10px;color:var(--red);}
.stat-row{padding:10px 16px;border-bottom:1px solid var(--rim);}
.stat-lbl{display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--dim);margin-bottom:5px;}
.stat-lbl .v1{color:var(--volt);}
.stat-lbl .v2{color:var(--sky);}
.stat-track{height:4px;background:var(--s4);border-radius:2px;position:relative;display:grid;grid-template-columns:1fr 1fr;}
.stat-left{height:4px;background:var(--volt);border-radius:2px;justify-self:end;animation:progress 1s ease both;}
.stat-right{height:4px;background:var(--sky);border-radius:2px;animation:progress 1s ease both;}

/* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
#view-history{display:none;flex-direction:column;height:100%;}
.hist-item{padding:11px 16px;border-bottom:1px solid var(--rim);cursor:pointer;transition:background .1s;position:relative;}
.hist-item:hover{background:var(--s2);}
.hi-top{display:flex;justify-content:space-between;margin-bottom:3px;gap:8px;}
.hi-title{font-size:12px;font-weight:600;color:var(--white);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.hi-time{font-family:var(--mono);font-size:9px;color:var(--dim);white-space:nowrap;}
.hi-prev{font-size:11px;color:var(--dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.hi-tags{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap;}
.hi-tag{font-family:var(--mono);font-size:8px;padding:1px 5px;border-radius:3px;background:var(--s3);color:var(--grey);}
.hi-sent{background:var(--grnfog);color:var(--green);}
.hist-item .hi-del{position:absolute;right:12px;top:11px;background:none;border:none;color:var(--dim);font-size:13px;cursor:pointer;display:none;}
.hist-item:hover .hi-del{display:block;}

/* ‚îÄ‚îÄ AUTOMATION ‚îÄ‚îÄ */
#view-automation{display:none;flex-direction:column;height:100%;}
.auto-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--rim);}
.auto-info{flex:1;}
.auto-name{font-size:12px;font-weight:600;color:var(--white);margin-bottom:2px;}
.auto-desc{font-size:10px;color:var(--dim);font-family:var(--mono);}
.auto-badge{font-family:var(--mono);font-size:9px;padding:2px 7px;border-radius:3px;font-weight:600;letter-spacing:.04em;cursor:pointer;border:none;}
.ab-on{background:var(--grnfog);color:var(--green);border:1px solid rgba(62,255,160,.25);}
.ab-off{background:var(--s3);color:var(--dim);border:1px solid var(--rim);}
.auto-bottom{padding:12px 16px;border-top:1px solid var(--rim);flex-shrink:0;}

/* ‚îÄ‚îÄ SCHEDULE ‚îÄ‚îÄ */
#view-schedule{display:none;flex-direction:column;height:100%;}
.sched-item{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--rim);}
.si-status{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.si-pending{background:var(--amber);animation:blink 2s infinite;}
.si-sent{background:var(--green);}
.si-time{font-family:var(--mono);font-size:10px;color:var(--amber);min-width:80px;}
.si-info{flex:1;}
.si-title{font-size:12px;font-weight:500;color:var(--white);}
.si-ch{font-size:10px;color:var(--dim);font-family:var(--mono);}
.si-del{opacity:0;transition:.1s;background:none;border:none;color:var(--dim);cursor:pointer;font-size:12px;}
.sched-item:hover .si-del{opacity:1;}

/* ‚îÄ‚îÄ RIGHT COL ‚îÄ‚îÄ */
.focus-card{padding:14px 16px;border-bottom:1px solid var(--rim);}
.fc-league{font-family:var(--mono);font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px;}
.fc-score-grid{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:6px;text-align:center;margin-bottom:12px;}
.fc-team-name{font-size:12px;font-weight:600;}
.fc-score-box{text-align:center;}
.fc-score{font-family:var(--display);font-size:32px;letter-spacing:.04em;color:var(--volt);}
.fc-min{font-family:var(--mono);font-size:9px;color:var(--red);margin-top:2px;}
.fc-actions{display:flex;gap:5px;justify-content:center;flex-wrap:wrap;}
.qev-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:10px 16px;border-bottom:1px solid var(--rim);}
.qev-btn{padding:7px 6px;background:var(--s2);border:1px solid var(--rim2);border-radius:6px;font-size:11px;font-weight:500;color:var(--grey);cursor:pointer;transition:.12s;text-align:center;font-family:var(--body);}
.qev-btn:hover{color:var(--white);border-color:var(--rim3);background:var(--s3);}
.scorer-row{display:flex;align-items:center;justify-content:space-between;padding:7px 16px;border-bottom:1px solid var(--rim);font-size:12px;}
.sr-left{display:flex;align-items:center;gap:6px;}
.sr-name{color:var(--white);font-weight:500;}
.sr-min{font-family:var(--mono);font-size:10px;color:var(--dim);}
.sr-team{font-family:var(--mono);font-size:10px;}

/* Bot token warning banner */
.bot-warning{margin:10px 16px;padding:10px 12px;background:var(--redfog);border:1px solid rgba(255,69,69,.3);border-radius:6px;font-size:11px;color:var(--red);display:flex;align-items:center;gap:8px;cursor:pointer;}
.bot-warning:hover{background:rgba(255,69,69,.15);}

.aff-panel{padding:14px 16px;border-bottom:1px solid var(--rim);background:linear-gradient(145deg,var(--vfog),transparent);border-left:2px solid var(--volt);}
.aff-header{display:flex;align-items:center;gap:8px;margin-bottom:10px;color:var(--volt);font-family:var(--display);font-size:13px;letter-spacing:.05em;}
.aff-badge{background:var(--volt);color:var(--bg);padding:2px 7px;border-radius:4px;font-size:9px;font-weight:700;font-family:var(--mono);}
.sched-mini{padding:8px 16px;}
.sm-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--rim);font-size:11px;}
.sm-row:last-child{border-bottom:none;}
.sm-title{color:var(--grey);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.sm-time{font-family:var(--mono);font-size:10px;color:var(--amber);margin-left:8px;white-space:nowrap;}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-bg{position:fixed;inset:0;z-index:900;background:rgba(7,8,15,.85);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;}
.modal-bg.open{display:flex;}
.modal{background:var(--s2);border:1px solid var(--rim2);border-radius:12px;padding:24px;width:460px;max-width:92vw;max-height:86vh;overflow-y:auto;position:relative;animation:pop .2s ease;}
.modal h3{font-family:var(--display);font-size:22px;letter-spacing:.04em;margin-bottom:4px;}
.modal p{font-size:12px;color:var(--dim);font-family:var(--mono);margin-bottom:18px;}
.modal-close{position:absolute;top:14px;right:16px;background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;transition:.12s;}
.modal-close:hover{color:var(--white);}
.modal-footer{display:flex;gap:8px;margin-top:16px;}
.btn-volt-solid{flex:1;padding:11px;background:var(--volt);color:var(--bg);border:none;border-radius:7px;font-family:var(--display);font-size:16px;letter-spacing:.06em;cursor:pointer;transition:.15s;}
.btn-volt-solid:hover{background:var(--volt2);}
.btn-cancel{padding:11px 20px;background:var(--s3);color:var(--grey);border:1px solid var(--rim2);border-radius:7px;font-size:13px;cursor:pointer;font-family:var(--body);transition:.15s;}
.btn-cancel:hover{color:var(--white);}
.modal-section{margin-bottom:16px;}
.modal-section-title{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.modal-section-title::before{content:'';width:6px;height:2px;background:var(--volt);border-radius:1px;}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--rim);}
.settings-row:last-child{border-bottom:none;}
.settings-row-label{font-size:12px;color:var(--white);}
.settings-row-sub{font-size:10px;color:var(--dim);font-family:var(--mono);margin-top:1px;}
.input-with-btn{display:flex;gap:6px;}
.input-with-btn .inp{flex:1;}
.inp-pass{font-family:var(--mono);font-size:11px;letter-spacing:.05em;}
.modal-info-box{background:var(--s3);border-radius:7px;padding:12px;font-size:12px;color:var(--grey);line-height:1.6;margin-bottom:12px;}
.modal-info-box code{background:var(--s4);padding:2px 6px;border-radius:3px;color:var(--volt);font-family:var(--mono);}
.kbd-list{display:flex;flex-direction:column;gap:8px;}
.kbd-row{display:flex;align-items:center;justify-content:space-between;}
.kbd-desc{font-size:12px;color:var(--grey);}
.kbds{display:flex;gap:4px;}
.kbd-key{background:var(--s3);border:1px solid var(--rim2);border-radius:4px;padding:3px 8px;font-family:var(--mono);font-size:11px;color:var(--grey);}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;bottom:20px;right:20px;z-index:9997;display:none;padding:10px 18px;border-radius:7px;font-size:12px;font-weight:500;font-family:var(--body);animation:slideUp .2s ease;box-shadow:0 6px 20px rgba(0,0,0,.5);}
.t-ok{background:#0b2616;color:var(--green);border:1px solid rgba(62,255,160,.25);}
.t-err{background:#250b0b;color:var(--red);border:1px solid rgba(255,69,69,.25);}
.t-inf{background:#0b1625;color:var(--sky);border:1px solid rgba(60,200,255,.25);}
.t-volt{background:#161f00;color:var(--volt);border:1px solid rgba(200,255,0,.25);}
.t-amber{background:#1e1400;color:var(--amber);border:1px solid rgba(255,176,32,.25);}

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
.empty{text-align:center;padding:28px 16px;font-size:11px;color:var(--dim);font-family:var(--mono);}
.empty a{color:var(--volt);text-decoration:none;}
.sp-sm{display:inline-block;width:11px;height:11px;border:2px solid var(--rim2);border-top-color:var(--volt);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:4px;}
.flex-1{flex:1;}
.gap-6{gap:6px;}

/* Scheduled runner indicator */
.runner-status{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:9px;color:var(--dim);}
.runner-dot{width:5px;height:5px;border-radius:50%;background:var(--dim);}
.runner-dot.active{background:var(--green);animation:blink 2s infinite;}

/* Prediction badge */
.prediction-card{margin:10px 16px;padding:10px 12px;background:var(--prpfog);border:1px solid rgba(184,127,255,.25);border-radius:6px;}
.pred-title{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--purple);margin-bottom:6px;}
.pred-options{display:flex;gap:6px;}
.pred-opt{flex:1;padding:6px;background:var(--s3);border:1px solid var(--rim);border-radius:5px;text-align:center;font-size:11px;color:var(--grey);cursor:pointer;transition:.12s;}
.pred-opt:hover{border-color:var(--purple);color:var(--purple);}
.pred-opt.sel{border-color:var(--purple);color:var(--purple);background:var(--prpfog);}

@media(max-width:1080px){.app{grid-template-columns:260px 1fr;}.col-r{display:none;}}
@media(max-width:700px){.app{grid-template-columns:1fr;}.col-l{display:none;}.ticker-mini{display:none;}}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="logo" onclick="">
    <div class="logo-mark">‚ö°</div>AUTOPOST<span>PRO</span>
    <span style="font-size:11px;color:var(--dim);margin-left:4px;font-family:var(--mono);">v2.0</span>
  </div>

  <div class="ticker-mini">
    <span class="tm-label"><span class="dot"></span>LIVE</span>
    <div class="tm-scroll">
      <div class="tm-inner" id="ticker-data">
        <span class="tm-item">Waiting for live data‚Ä¶</span>
      </div>
    </div>
  </div>

  <div class="hdr-right">
    <div class="runner-status" id="runner-status" title="Scheduled post runner">
      <span class="runner-dot" id="runner-dot"></span>
      <span id="runner-txt">Runner idle</span>
    </div>
    <button class="notif-btn" id="notif-btn" onclick="toggleNotifications()" title="Toggle live notifications">üîî<span class="notif-dot" id="notif-dot"></span></button>
    <button class="hdr-btn" onclick="openModal('modal-settings')">‚öô Settings</button>
    <button class="hdr-btn" onclick="openModal('modal-shortcuts')" style="border-color:var(--dim);">‚å®</button>
  </div>
</header>

<!-- 3-COLUMN APP -->
<div class="app">

  <!-- LEFT COLUMN -->
  <div class="col col-l">
    <div class="type-tabs">
      <div class="ttab on" onclick="setType('live',this)">üî¥ Live</div>
      <div class="ttab" onclick="setType('preview',this)">üìÖ Preview</div>
      <div class="ttab" onclick="setType('standings',this)">üèÜ Table</div>
      <div class="ttab" onclick="setType('digest',this)">üìä Digest</div>
      <div class="ttab" onclick="setType('prediction',this)">üéØ Predict</div>
      <div class="ttab" onclick="setType('custom',this)">‚úèÔ∏è Custom</div>
    </div>

    <div id="custom-prompt" style="display:none;padding:8px 16px;border-bottom:1px solid var(--rim);">
      <label class="lbl">Your Prompt</label>
      <textarea class="textarea" id="custom-txt" placeholder="e.g. Write an exciting 3-line goal alert in Arabic for Saka scoring in minute 67‚Ä¶"></textarea>
    </div>

    <div id="standings-opts" style="display:none;padding:8px 16px;border-bottom:1px solid var(--rim);">
      <label class="lbl">League for Standings</label>
      <div class="sel-wrap">
        <select class="sel" id="standings-league">
          <option value="39">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League</option>
          <option value="140">üá™üá∏ La Liga</option>
          <option value="135">üáÆüáπ Serie A</option>
          <option value="78">üá©üá™ Bundesliga</option>
          <option value="61">üá´üá∑ Ligue 1</option>
          <option value="2">üåç Champions League</option>
          <option value="3">üåç Europa League</option>
        </select>
      </div>
    </div>

    <div id="prediction-opts" style="display:none;padding:8px 16px;border-bottom:1px solid var(--rim);">
      <label class="lbl">Prediction Type</label>
      <div class="pred-options" id="pred-type-opts">
        <div class="pred-opt sel" onclick="pickPred(this,'btts')">BTTS</div>
        <div class="pred-opt" onclick="pickPred(this,'1x2')">1X2</div>
        <div class="pred-opt" onclick="pickPred(this,'goals')">Goals O/U</div>
        <div class="pred-opt" onclick="pickPred(this,'combo')">Combo</div>
      </div>
    </div>

    <!-- Fixture filter + search -->
    <div class="sec" id="match-sec-hdr">
      <div class="sec-title">Fixtures</div>
      <div class="sec-actions">
        <button class="mb on" id="f-all" onclick="filterBy('all')">All</button>
        <button class="mb sky" id="f-live" onclick="filterBy('live')">Live</button>
        <button class="mb" onclick="loadMatches()" title="Refresh">‚Üª</button>
      </div>
    </div>
    <div class="search-wrap" id="match-search-wrap">
      <input class="search-inp" type="text" placeholder="Search team or league‚Ä¶" oninput="searchMatches(this.value)" id="match-search">
      <select class="league-filter" id="league-filter" onchange="filterByLeague(this.value)" title="Filter by league">
        <option value="">All</option>
      </select>
    </div>

    <div class="scrollable" id="match-list">
      <div class="empty">Click ‚Üª to load today's matches</div>
    </div>

    <!-- AI Options -->
    <div class="sec"><div class="sec-title">AI Options</div></div>
    <div style="padding:10px 16px 4px;">
      <div class="field" style="padding:0 0 10px;">
        <label class="lbl">Tone</label>
        <div class="sel-wrap"><select class="sel" id="tone">
          <option value="professional">üì∞ Professional</option>
          <option value="excited">üî• Excited & Energetic</option>
          <option value="casual">üòé Casual</option>
          <option value="dramatic">‚ö° Dramatic</option>
          <option value="analytical">üßÆ Analytical</option>
          <option value="poetic">üé≠ Poetic / Creative</option>
        </select></div>
      </div>
      <div class="field" style="padding:0 0 10px;">
        <label class="lbl">Length</label>
        <div class="sel-wrap"><select class="sel" id="length">
          <option value="tweet">Tweet (‚â§280 chars)</option>
          <option value="short">Short (2‚Äì3 lines)</option>
          <option value="medium" selected>Medium (4‚Äì6 lines)</option>
          <option value="detailed">Detailed (8‚Äì12 lines)</option>
          <option value="article">Full Report (15+ lines)</option>
        </select></div>
      </div>
      <div class="field" style="padding:0 0 8px;">
        <label class="lbl">Language</label>
        <div class="sel-wrap"><select class="sel" id="lang">
          <option value="en">üá¨üáß English</option>
          <option value="ar">üá∏üá¶ Arabic</option>
          <option value="fr">üá´üá∑ French</option>
          <option value="es">üá™üá∏ Spanish</option>
          <option value="pt">üáßüá∑ Portuguese</option>
          <option value="sw">üá∞üá™ Swahili</option>
          <option value="de">üá©üá™ German</option>
          <option value="it">üáÆüáπ Italian</option>
        </select></div>
      </div>
    </div>
    <div class="tog"><div class="tog-info"><div class="tog-name">Match stats</div><div class="tog-sub">possession, shots, corners</div></div><label class="sw"><input type="checkbox" id="inc-stats" checked><span class="sw-track"></span></label></div>
    <div class="tog"><div class="tog-info"><div class="tog-name">Top performers</div><div class="tog-sub">goals, assists, ratings</div></div><label class="sw"><input type="checkbox" id="inc-players" checked><span class="sw-track"></span></label></div>
    <div class="tog"><div class="tog-info"><div class="tog-name">Head-to-head history</div><div class="tog-sub">last 5 meetings</div></div><label class="sw"><input type="checkbox" id="inc-h2h"><span class="sw-track"></span></label></div>
    <div class="tog"><div class="tog-info"><div class="tog-name">Auto hashtags</div><div class="tog-sub">appends relevant #tags</div></div><label class="sw"><input type="checkbox" id="inc-hashtags" checked><span class="sw-track"></span></label></div>
    <div class="tog"><div class="tog-info"><div class="tog-name">Include affiliate</div><div class="tog-sub">support us by adding link</div></div><label class="sw"><input type="checkbox" id="inc-aff" checked><span class="sw-track"></span></label></div>
    <div class="tog" style="border-bottom:1px solid var(--rim);"><div class="tog-info"><div class="tog-name">Emojis</div><div class="tog-sub">adds ‚öΩüî• to message</div></div><label class="sw"><input type="checkbox" id="inc-emojis" checked><span class="sw-track"></span></label></div>

    <!-- Templates -->
    <div class="sec"><div class="sec-title">Templates</div><button class="mb" onclick="openModal('modal-tpl')">+ New</button></div>
    <div class="tpl-row">
      <span class="tpl-chip on" onclick="pickTpl(this,'default')">‚ö° Default</span>
      <span class="tpl-chip" onclick="pickTpl(this,'goal')">‚öΩ Goal Alert</span>
      <span class="tpl-chip" onclick="pickTpl(this,'halftime')">üîî Half Time</span>
      <span class="tpl-chip" onclick="pickTpl(this,'fulltime')">üèÅ Full Time</span>
      <span class="tpl-chip" onclick="pickTpl(this,'preview')">üìÖ Preview</span>
      <span class="tpl-chip" onclick="pickTpl(this,'red')">üü• Red Card</span>
      <span class="tpl-chip" onclick="pickTpl(this,'lineup')">üìã Lineups</span>
      <span class="tpl-chip" onclick="pickTpl(this,'penalty')">üéØ Penalty</span>
      <span class="tpl-chip" onclick="pickTpl(this,'prediction')">üîÆ Prediction</span>
    </div>

    <div class="gen-wrap">
      <button class="gen-btn" id="gen-btn" onclick="generate()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        GENERATE MESSAGE
        <kbd>‚åòG</kbd>
      </button>
    </div>
  </div>

  <!-- MIDDLE COLUMN -->
  <div class="col col-m">
    <div class="mid-tabs">
      <div class="mtab on" onclick="switchMid('message',this)">Message</div>
      <div class="mtab" onclick="switchMid('events',this)">Live Events</div>
      <div class="mtab" onclick="switchMid('fixtures',this)">All Fixtures</div>
      <div class="mtab" onclick="switchMid('stats',this)">Match Stats</div>
      <div class="mtab" onclick="switchMid('history',this)">History</div>
      <div class="mtab" onclick="switchMid('automation',this)">Automation</div>
      <div class="mtab" onclick="switchMid('schedule',this)">Schedule</div>
    </div>

    <!-- MESSAGE VIEW -->
    <div id="view-message" style="display:flex;flex-direction:column;height:100%;overflow:hidden;">
      <div class="msg-actions">
        <div class="ma-left">
          <button class="action-btn" onclick="copyMsg()" title="Copy (Ctrl+C)">üìã Copy</button>
          <button class="action-btn" onclick="editMsg()" id="edit-btn">‚úèÔ∏è Edit</button>
          <button class="action-btn" onclick="regenerate()" title="Regenerate (Ctrl+R)">‚Üª Retry</button>
          <button class="action-btn" onclick="saveMsg()">üíæ Save</button>
          <button class="action-btn" onclick="openModal('modal-schedule')">‚è∞ Schedule</button>
          <button class="action-btn volt" onclick="showHashtags()" id="htag-btn" title="Generate hashtags">üè∑ Tags</button>
        </div>
        <div class="ma-right">
          <span id="gen-ts"></span>
          <div class="char-counter" id="char-counter">
            <span id="char-count" style="font-size:10px;color:var(--dim);">‚Äî</span>
          </div>
        </div>
      </div>

      <!-- Platform character limits bar -->
      <div class="platform-limits" id="platform-limits">
        <div class="plat-pill" id="pl-twitter"><span class="plat-name">X/Twitter</span>&nbsp;<span class="plat-count" id="plc-twitter">‚Äî</span></div>
        <div class="plat-pill" id="pl-telegram"><span class="plat-name">Telegram</span>&nbsp;<span class="plat-count" id="plc-telegram">‚Äî</span></div>
        <div class="plat-pill" id="pl-whatsapp"><span class="plat-name">WhatsApp</span>&nbsp;<span class="plat-count" id="plc-whatsapp">‚Äî</span></div>
        <div class="plat-pill" id="pl-instagram"><span class="plat-name">Instagram</span>&nbsp;<span class="plat-count" id="plc-instagram">‚Äî</span></div>
      </div>

      <!-- Hashtag strip (hidden until requested) -->
      <div class="hashtag-strip" id="hashtag-strip">
        <div class="hashtag-label">
          <span>Suggested Hashtags ‚Äî click to append</span>
          <button class="mb" onclick="appendAllHashtags()">Add All</button>
        </div>
        <div class="hashtag-tags" id="hashtag-tags"></div>
      </div>

      <div class="msg-body" id="msg-body">
        <div class="msg-placeholder" id="msg-ph">
          <div class="mp-icon">‚ú®</div>
          <p class="mp-text">Select a match, then<br>click <strong>Generate Message</strong></p>
          <div class="mp-shortcuts">
            <div class="mp-sc-item"><kbd>Ctrl+G</kbd><span>Generate</span></div>
            <div class="mp-sc-item"><kbd>Ctrl+C</kbd><span>Copy message</span></div>
            <div class="mp-sc-item"><kbd>Ctrl+R</kbd><span>Regenerate</span></div>
            <div class="mp-sc-item"><kbd>Ctrl+Enter</kbd><span>Send to Telegram</span></div>
          </div>
          <span style="font-size:11px;color:var(--volt);margin-top:8px;display:block;">‚ö° 100% FREE ¬∑ No limits</span>
        </div>
        <span id="msg-txt" style="display:none;"></span>
        <div class="gen-overlay" id="gen-overlay">
          <div class="ring-loader"></div>
          <div class="gen-status-txt" id="gen-status">Crafting your message‚Ä¶</div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--dim);margin-top:4px;" id="gen-sub"></div>
        </div>
      </div>

      <div class="copy-bar" id="copy-bar" onclick="copyMsg()">
        <span>üìã Click to copy ¬∑ paste into WhatsApp, Instagram, X</span>
        <span style="opacity:.5;font-family:var(--mono);font-size:10px;">ctrl+c</span>
      </div>

      <!-- BOT TOKEN WARNING -->
      <div class="bot-warning" id="bot-warning" onclick="openModal('modal-settings')" style="display:none;">
        ‚ö†Ô∏è No Telegram bot token set ‚Äî click to configure in Settings
      </div>

      <!-- Channels -->
      <div class="send-panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <span style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);">Send To Channels</span>
          <div style="display:flex;gap:4px;">
            <button class="mb" onclick="selAllCh(true)">All</button>
            <button class="mb" onclick="selAllCh(false)">None</button>
            <button class="mb" onclick="openModal('modal-channel')">+ Add</button>
          </div>
        </div>
        <div id="ch-list"></div>
        <button class="send-btn" id="send-tg-btn" onclick="sendAll()" title="Send (Ctrl+Enter)">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          SEND TO TELEGRAM
        </button>
        <div class="send-btns-row">
          <button class="send-sub wa" onclick="openWhatsApp()">üì± WhatsApp</button>
          <button class="send-sub x" onclick="openTwitter()">ùïè Tweet</button>
          <button class="send-sub" onclick="openModal('modal-schedule')">‚è∞ Schedule</button>
        </div>
      </div>

      <div class="msg-footer">
        <span id="msg-footer-l">Ready</span>
        <span>AutoPost Pro v2 ¬∑ ‚ö° Free</span>
      </div>
    </div>

    <!-- LIVE EVENTS -->
    <div id="view-events" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
      <div class="ev-match-bar">
        <div><div class="emb-score" id="ev-score">‚Äî</div><div class="emb-info" id="ev-info">‚Äî</div></div>
        <button class="mb sky" onclick="loadEvents()">‚Üª Refresh</button>
      </div>
      <div class="scrollable" id="ev-list"><div class="empty">Select a match to see live events</div></div>
      <div class="ev-bottom">
        <button class="gen-btn" onclick="quickPost('summary','','','')" style="font-size:14px;padding:10px;">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          GENERATE LIVE SUMMARY
        </button>
      </div>
    </div>

    <!-- FIXTURES -->
    <div id="view-fixtures" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
      <div class="fix-toolbar">
        <input type="date" class="date-inp" id="fixture-date" onchange="loadFixtures()" title="Select date">
        <button class="mb sky" onclick="loadFixtures()">‚Üª</button>
        <button class="mb" onclick="copyAllFixtures()">üìã Copy All</button>
        <button class="mb" onclick="genDigest()" style="margin-left:auto;">‚ú¶ Digest</button>
      </div>
      <div class="scrollable" id="fixtures-list"><div class="empty">Loading fixtures‚Ä¶</div></div>
      <div style="padding:12px 16px;border-top:1px solid var(--rim);display:flex;gap:8px;flex-shrink:0;">
        <button class="gen-btn" onclick="genDigest()" style="font-size:14px;padding:10px;">‚ú¶ GENERATE FULL DIGEST</button>
        <button class="action-btn" onclick="copyAllFixtures()" style="white-space:nowrap;padding:10px 16px;">üìã Copy All</button>
      </div>
    </div>

    <!-- STATS -->
    <div id="view-stats" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
      <div class="stats-header">
        <div><div class="sh-team" style="color:var(--volt);" id="st-home">‚Äî</div></div>
        <div><div class="sh-score" id="st-score">‚Äì</div><div class="sh-status" id="st-min"></div></div>
        <div><div class="sh-team" style="color:var(--sky);" id="st-away">‚Äî</div></div>
      </div>
      <div class="scrollable" id="stats-list"><div class="empty">Select a match to see stats</div></div>
      <div style="padding:12px 16px;border-top:1px solid var(--rim);flex-shrink:0;">
        <button class="gen-btn" onclick="generate()" style="font-size:14px;padding:10px;">‚ú¶ GENERATE STATS REPORT</button>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="view-history" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
      <div class="sec">
        <div class="sec-title">Message History</div>
        <div class="sec-actions">
          <button class="mb" onclick="exportHistory()">‚Üì Export</button>
          <button class="mb red" onclick="clearHistory()">Clear</button>
        </div>
      </div>
      <div class="scrollable" id="hist-list"></div>
    </div>

    <!-- AUTOMATION -->
    <div id="view-automation" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
      <div class="sec"><div class="sec-title">Auto-Post Rules</div><button class="mb" onclick="openModal('modal-auto')">+ Add Rule</button></div>
      <div style="padding:8px 16px;border-bottom:1px solid var(--rim);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
        <span style="font-size:11px;color:var(--dim);font-family:var(--mono);">Automation requires bot token + active channels</span>
        <div class="runner-status"><span class="runner-dot" id="runner-dot2"></span><span id="runner-txt2">Idle</span></div>
      </div>
      <div class="scrollable" id="auto-list"></div>
      <div class="auto-bottom">
        <button class="gen-btn" onclick="openModal('modal-auto')" style="font-size:14px;padding:10px;">+ CREATE NEW RULE</button>
      </div>
    </div>

    <!-- SCHEDULE -->
    <div id="view-schedule" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
      <div class="sec">
        <div class="sec-title">Scheduled Posts</div>
        <div class="sec-actions">
          <button class="mb" onclick="openModal('modal-schedule')">+ New</button>
        </div>
      </div>
      <div style="padding:6px 16px;border-bottom:1px solid var(--rim);font-family:var(--mono);font-size:9px;color:var(--dim);flex-shrink:0;display:flex;align-items:center;gap:6px;">
        <span class="runner-dot active"></span> Scheduler checks every 60s and auto-sends when time is reached
      </div>
      <div class="scrollable" id="sched-list"></div>
      <div style="padding:12px 16px;border-top:1px solid var(--rim);flex-shrink:0;">
        <button class="gen-btn" onclick="openModal('modal-schedule')" style="font-size:14px;padding:10px;">+ SCHEDULE NEW POST</button>
      </div>
    </div>
  </div>

  <!-- RIGHT COLUMN -->
  <div class="col col-r">
    <div class="sec"><div class="sec-title">Match Focus</div><button class="mb sky" onclick="loadMatches()">‚Üª</button></div>
    <div class="focus-card">
      <div class="fc-league" id="fc-league">‚Äî Select a match ‚Äî</div>
      <div class="fc-score-grid">
        <div><div style="font-size:20px;margin-bottom:5px;" id="fc-home-icon">üî¥</div><div class="fc-team-name" id="fc-home">Home</div></div>
        <div class="fc-score-box">
          <div class="fc-score" id="fc-score">‚Äì</div>
          <div class="fc-min" id="fc-min"></div>
        </div>
        <div><div style="font-size:20px;margin-bottom:5px;" id="fc-away-icon">üîµ</div><div class="fc-team-name" id="fc-away">Away</div></div>
      </div>
      <div class="fc-actions">
        <button class="mb" onclick="switchMid('events',null)">Events</button>
        <button class="mb" onclick="switchMid('stats',null)">Stats</button>
        <button class="mb on" onclick="generate()">‚ú¶ Generate</button>
      </div>
    </div>

    <div class="sec"><div class="sec-title">Quick Event Posts</div></div>
    <div class="qev-grid">
      <button class="qev-btn" onclick="quickPost('goal','','','')">‚öΩ Goal Alert</button>
      <button class="qev-btn" onclick="quickPost('halftime','','','')">üîî Half Time</button>
      <button class="qev-btn" onclick="quickPost('fulltime','','','')">üèÅ Full Time</button>
      <button class="qev-btn" onclick="quickPost('red','','','')">üü• Red Card</button>
      <button class="qev-btn" onclick="quickPost('penalty','','','')">üéØ Penalty</button>
      <button class="qev-btn" onclick="quickPost('var','','','')">üì∫ VAR Review</button>
      <button class="qev-btn" onclick="quickPost('kickoff','','','')">üèüÔ∏è Kick Off</button>
      <button class="qev-btn" onclick="quickPost('injury','','','')">üöë Injury</button>
    </div>

    <div class="sec"><div class="sec-title">Scorers</div></div>
    <div id="scorers-list"><div class="scorer-row" style="justify-content:center;"><span style="color:var(--dim);font-family:var(--mono);font-size:10px;">No goals yet</span></div></div>

    <div class="aff-panel">
      <div class="aff-header">üîó AFFILIATE LINK <span class="aff-badge">OPTIONAL</span></div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <input class="inp" id="aff-label" type="text" placeholder="Label e.g. üîó Bet365" value="üîó Bet Now">
        <div style="display:flex;gap:6px;">
          <input class="inp" id="aff-url" type="text" placeholder="https://your-affiliate-link.com" style="flex:1;">
          <button class="mb" onclick="saveAffiliate()">Save</button>
        </div>
        <div style="font-size:10px;color:var(--dim);font-family:var(--mono);">Added to posts when "Include affiliate" is on</div>
      </div>
    </div>

    <div class="sec"><div class="sec-title">Upcoming Scheduled</div><button class="mb" onclick="switchMid('schedule',null)">View all</button></div>
    <div class="sched-mini" id="sched-mini-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->

<!-- SETTINGS MODAL (NEW - CRITICAL) -->
<div class="modal-bg" id="modal-settings">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-settings')">‚úï</button>
    <h3>‚öô Settings</h3>
    <p>Configure your bot, API keys, and preferences</p>

    <div class="modal-section">
      <div class="modal-section-title">Telegram Bot Token</div>
      <div class="modal-info-box">
        Create a bot via <code>@BotFather</code> on Telegram ‚Üí send <code>/newbot</code> ‚Üí copy the token here. Then add your bot as admin to your channels.
      </div>
      <div style="padding:0 0 10px;">
        <label class="lbl">Bot Token</label>
        <div class="input-with-btn">
          <input class="inp inp-pass" type="password" id="settings-bot-token" placeholder="1234567890:ABCDEFGhijklmnopqrstuvwxyz-abc">
          <button class="mb" onclick="toggleTokenVisibility()">üëÅ</button>
          <button class="mb" onclick="saveBotToken()" style="border-color:var(--volt);color:var(--volt);">Save</button>
        </div>
      </div>
      <div id="token-status" style="font-family:var(--mono);font-size:10px;color:var(--dim);margin-top:4px;"></div>
    </div>

    <div class="modal-section" style="margin-top:16px;">
      <div class="modal-section-title">Football API Key (optional)</div>
      <div class="modal-info-box">
        Get a free key from <code>api-football.com</code> for real match data. Without it, demo/mock data is used.
      </div>
      <div style="padding:0;">
        <label class="lbl">API-Football Key</label>
        <div class="input-with-btn">
          <input class="inp inp-pass" type="password" id="settings-api-key" placeholder="Your API key‚Ä¶">
          <button class="mb" onclick="saveApiKey()" style="border-color:var(--volt);color:var(--volt);">Save</button>
        </div>
      </div>
    </div>

    <div class="modal-section" style="margin-top:16px;">
      <div class="modal-section-title">Preferences</div>
      <div class="settings-row">
        <div><div class="settings-row-label">Auto-refresh live matches</div><div class="settings-row-sub">Refresh every 30s while app is open</div></div>
        <label class="sw"><input type="checkbox" id="pref-autorefresh" checked><span class="sw-track"></span></label>
      </div>
      <div class="settings-row">
        <div><div class="settings-row-label">Show platform limits bar</div><div class="settings-row-sub">Twitter, Telegram character counts</div></div>
        <label class="sw"><input type="checkbox" id="pref-platform-limits" checked><span class="sw-track"></span></label>
      </div>
      <div class="settings-row">
        <div><div class="settings-row-label">Dark mode only</div><div class="settings-row-sub">App always uses dark theme</div></div>
        <label class="sw"><input type="checkbox" id="pref-dark" checked disabled><span class="sw-track"></span></label>
      </div>
    </div>

    <div class="modal-section" style="margin-top:16px;">
      <div class="modal-section-title">Danger Zone</div>
      <div style="display:flex;gap:8px;">
        <button class="btn-cancel" onclick="clearAllData()" style="color:var(--red);border-color:rgba(255,69,69,.3);">üóë Clear All Data</button>
        <button class="btn-cancel" onclick="exportAllData()">‚Üì Export Data</button>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-volt-solid" onclick="saveSettings();closeModal('modal-settings')">SAVE & CLOSE</button>
      <button class="btn-cancel" onclick="closeModal('modal-settings')">Cancel</button>
    </div>
  </div>
</div>

<!-- KEYBOARD SHORTCUTS MODAL (NEW) -->
<div class="modal-bg" id="modal-shortcuts">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-shortcuts')">‚úï</button>
    <h3>‚å® Keyboard Shortcuts</h3>
    <p>Speed up your workflow with these shortcuts</p>
    <div class="kbd-list">
      <div class="kbd-row"><span class="kbd-desc">Generate message</span><div class="kbds"><span class="kbd-key">Ctrl</span><span class="kbd-key">G</span></div></div>
      <div class="kbd-row"><span class="kbd-desc">Copy message</span><div class="kbds"><span class="kbd-key">Ctrl</span><span class="kbd-key">C</span></div></div>
      <div class="kbd-row"><span class="kbd-desc">Regenerate</span><div class="kbds"><span class="kbd-key">Ctrl</span><span class="kbd-key">R</span></div></div>
      <div class="kbd-row"><span class="kbd-desc">Send to Telegram</span><div class="kbds"><span class="kbd-key">Ctrl</span><span class="kbd-key">Enter</span></div></div>
      <div class="kbd-row"><span class="kbd-desc">Toggle edit mode</span><div class="kbds"><span class="kbd-key">Ctrl</span><span class="kbd-key">E</span></div></div>
      <div class="kbd-row"><span class="kbd-desc">Save to history</span><div class="kbds"><span class="kbd-key">Ctrl</span><span class="kbd-key">S</span></div></div>
      <div class="kbd-row"><span class="kbd-desc">Open settings</span><div class="kbds"><span class="kbd-key">Ctrl</span><span class="kbd-key">,</span></div></div>
      <div class="kbd-row"><span class="kbd-desc">Refresh matches</span><div class="kbds"><span class="kbd-key">Ctrl</span><span class="kbd-key">Shift</span><span class="kbd-key">R</span></div></div>
    </div>
    <div class="modal-footer"><button class="btn-volt-solid" onclick="closeModal('modal-shortcuts')">GOT IT</button></div>
  </div>
</div>

<!-- Template Modal -->
<div class="modal-bg" id="modal-tpl">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-tpl')">‚úï</button>
    <h3>New Template</h3>
    <p>Define a reusable message structure</p>
    <div style="padding:0 0 12px;"><label class="lbl">Name</label><input class="inp" id="tpl-name" type="text" placeholder="e.g. Goal Alert Arabic"></div>
    <div style="padding:0 0 12px;"><label class="lbl">Trigger</label><div class="sel-wrap"><select class="sel" id="tpl-trigger"><option>Goal scored</option><option>Half time</option><option>Full time</option><option>Red card</option><option>Penalty</option><option>Manual</option></select></div></div>
    <div style="padding:0;"><label class="lbl">Prompt Instructions</label><textarea class="textarea" id="tpl-prompt" placeholder="Write a 3-line goal alert in Arabic. Include player name, minute, score. Use fire emoji." style="min-height:80px;"></textarea></div>
    <div class="modal-footer"><button class="btn-volt-solid" onclick="saveTemplate()">SAVE TEMPLATE</button><button class="btn-cancel" onclick="closeModal('modal-tpl')">Cancel</button></div>
  </div>
</div>

<!-- Automation Modal -->
<div class="modal-bg" id="modal-auto">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-auto')">‚úï</button>
    <h3>New Auto Rule</h3>
    <p>AutoPost Pro will detect this event and post automatically</p>
    <div style="padding:0 0 10px;"><label class="lbl">Rule Name</label><input class="inp" id="auto-name" type="text" placeholder="e.g. PL Goal Alerts"></div>
    <div style="padding:0 0 10px;"><label class="lbl">Trigger Event</label><div class="sel-wrap"><select class="sel" id="auto-trigger"><option>‚öΩ Goal scored</option><option>üîî Half time</option><option>üèÅ Full time</option><option>üü• Red card</option><option>üü® Yellow card</option><option>üéØ Penalty awarded</option><option>üì∫ VAR decision</option><option>üèüÔ∏è Match kick-off</option><option>üîÑ Substitution</option></select></div></div>
    <div style="padding:0 0 10px;"><label class="lbl">League Filter</label><div class="sel-wrap"><select class="sel" id="auto-league"><option>All leagues</option><option>Premier League only</option><option>Champions League only</option><option>La Liga only</option><option>Serie A only</option></select></div></div>
    <div style="padding:0 0 10px;"><label class="lbl">Tone</label><div class="sel-wrap"><select class="sel" id="auto-tone"><option>üî• Excited</option><option>üì∞ Professional</option><option>‚ö° Dramatic</option><option>üòé Casual</option></select></div></div>
    <div style="padding:0;"><label class="lbl">Send To</label><div class="sel-wrap"><select class="sel" id="auto-channels"><option>All channels</option></select></div></div>
    <div class="modal-footer"><button class="btn-volt-solid" onclick="addAutoRule()">CREATE RULE</button><button class="btn-cancel" onclick="closeModal('modal-auto')">Cancel</button></div>
  </div>
</div>

<!-- Schedule Modal -->
<div class="modal-bg" id="modal-schedule">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-schedule')">‚úï</button>
    <h3>Schedule Post</h3>
    <p>Post will auto-send when the time arrives (tab must be open)</p>
    <div style="padding:0 0 10px;"><label class="lbl">Date & Time</label><input class="inp" type="datetime-local" id="sched-dt"></div>
    <div style="padding:0 0 10px;"><label class="lbl">Message Preview</label><textarea class="textarea" id="sched-msg-preview" placeholder="Generate a message first, or type here‚Ä¶" style="min-height:90px;"></textarea></div>
    <div style="padding:0 0 10px;"><label class="lbl">Send To</label><div class="sel-wrap"><select class="sel" id="sched-channels"><option>All selected channels</option></select></div></div>
    <div style="padding:0;background:var(--ambfog);border:1px solid rgba(255,176,32,.2);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--amber);font-family:var(--mono);">
      ‚ö†Ô∏è Keep this tab open for scheduled posts to send automatically. The scheduler checks every 60 seconds.
    </div>
    <div class="modal-footer"><button class="btn-volt-solid" onclick="schedulePost()">SCHEDULE</button><button class="btn-cancel" onclick="closeModal('modal-schedule')">Cancel</button></div>
  </div>
</div>

<!-- Add Channel Modal -->
<div class="modal-bg" id="modal-channel">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-channel')">‚úï</button>
    <h3>Connect Channel</h3>
    <p>Add your Telegram channel or group</p>
    <div class="modal-info-box">
      <strong style="color:var(--white);display:block;margin-bottom:4px;">Step 1:</strong>
      Add <code>@AutoPostProBot</code> as admin to your channel
      <strong style="color:var(--white);display:block;margin:8px 0 4px;">Step 2:</strong>
      Send <code>/start</code> in the channel, then forward a message to <code>@userinfobot</code> to get your Channel ID (starts with -100‚Ä¶)
    </div>
    <div style="padding:0 0 10px;"><label class="lbl">Channel Name</label><input class="inp" type="text" id="new-ch-name" placeholder="e.g. Arsenal Fan Zone"></div>
    <div style="padding:0;"><label class="lbl">Channel ID</label><input class="inp" type="text" id="new-ch-id" placeholder="e.g. -1001234567890"></div>
    <div class="modal-footer"><button class="btn-volt-solid" onclick="addChannel()">CONNECT CHANNEL</button><button class="btn-cancel" onclick="closeModal('modal-channel')">Cancel</button></div>
  </div>
</div>

<div id="toast"></div>

<!-- JAVASCRIPT -->
<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentType = 'live';
let currentTpl  = 'default';
let currentMid  = 'message';
let selectedMatchId = null;
let allMatches = [];
let generatedMsg = '';
let predictionType = 'btts';
let notificationsEnabled = false;
let schedulerInterval = null;
let refreshInterval = null;
let customTemplates = [];

const PLATFORM_LIMITS = {
  twitter: 280,
  telegram: 4096,
  whatsapp: 65536,
  instagram: 2200
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  // Set today as default date for fixtures
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('fixture-date').value = today;

  // Load settings & check bot token
  loadSettings();
  checkBotToken();

  // Load all data
  loadChannelsFromStorage();
  loadHistoryFromStorage();
  loadAutoRules();
  loadScheduledPosts();
  loadAffiliate();
  loadCustomTemplates();
  updateTicker();

  // Start auto-refresh ticker
  setInterval(updateTicker, 30000);

  // Start scheduled post runner (every 60s)
  startScheduler();

  // Load initial matches
  loadMatches();

  // Keyboard shortcuts
  setupKeyboardShortcuts();

  // Register platform limits preference
  const showLimits = localStorage.getItem('ap_pref_platform_limits') !== 'false';
  document.getElementById('pref-platform-limits').checked = showLimits;
  document.getElementById('pref-platform-limits').onchange = function() {
    document.getElementById('platform-limits').style.display = this.checked ? 'flex' : 'none';
    localStorage.setItem('ap_pref_platform_limits', this.checked);
  };
  if (!showLimits) document.getElementById('platform-limits').style.display = 'none';

  // Auto-refresh preference
  const autoRefresh = localStorage.getItem('ap_pref_autorefresh') !== 'false';
  document.getElementById('pref-autorefresh').checked = autoRefresh;
  document.getElementById('pref-autorefresh').onchange = function() {
    localStorage.setItem('ap_pref_autorefresh', this.checked);
    if (this.checked) startAutoRefresh(); else stopAutoRefresh();
  };
  if (autoRefresh) startAutoRefresh();
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SETTINGS (CRITICAL - was missing)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadSettings() {
  const token = localStorage.getItem('ap_botToken');
  if (token) document.getElementById('settings-bot-token').value = token;
  const apiKey = localStorage.getItem('ap_apiKey');
  if (apiKey) document.getElementById('settings-api-key').value = apiKey;
}

function checkBotToken() {
  const token = localStorage.getItem('ap_botToken');
  const warning = document.getElementById('bot-warning');
  const tokenStatus = document.getElementById('token-status');
  if (!token || token.length < 20) {
    warning.style.display = 'flex';
    if (tokenStatus) tokenStatus.textContent = '‚ùå No token configured';
    if (tokenStatus) tokenStatus.style.color = 'var(--red)';
  } else {
    warning.style.display = 'none';
    if (tokenStatus) tokenStatus.textContent = '‚úÖ Token configured ¬∑ ' + token.substring(0, 10) + '‚Ä¶';
    if (tokenStatus) tokenStatus.style.color = 'var(--green)';
  }
}

function saveBotToken() {
  const token = document.getElementById('settings-bot-token').value.trim();
  if (!token) { toast('Enter a bot token', 'err'); return; }
  if (!token.includes(':') || token.length < 20) {
    toast('Token format looks wrong ‚Äî check BotFather', 'err'); return;
  }
  localStorage.setItem('ap_botToken', token);
  checkBotToken();
  toast('Bot token saved ‚úì', 'ok');
}

function saveApiKey() {
  const key = document.getElementById('settings-api-key').value.trim();
  localStorage.setItem('ap_apiKey', key);
  toast('API key saved ‚úì', 'ok');
}

function toggleTokenVisibility() {
  const inp = document.getElementById('settings-bot-token');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

function saveSettings() {
  // All saves happen in-place; this just confirms
  toast('Settings saved ‚úì', 'ok');
}

function clearAllData() {
  if (!confirm('Clear ALL saved data? This cannot be undone.')) return;
  ['ap_channels','ap_posts','ap_scheduled','ap_auto_rules','ap_affiliate','ap_templates'].forEach(k => localStorage.removeItem(k));
  loadChannelsFromStorage(); loadHistoryFromStorage(); loadAutoRules(); loadScheduledPosts();
  toast('All data cleared', 'inf');
}

function exportAllData() {
  const data = {
    channels: JSON.parse(localStorage.getItem('ap_channels') || '[]'),
    history: JSON.parse(localStorage.getItem('ap_posts') || '[]'),
    scheduled: JSON.parse(localStorage.getItem('ap_scheduled') || '[]'),
    autoRules: JSON.parse(localStorage.getItem('ap_auto_rules') || '[]'),
    affiliate: JSON.parse(localStorage.getItem('ap_affiliate') || '{}'),
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'autopost-pro-backup.json';
  a.click();
  toast('Data exported ‚úì', 'ok');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// KEYBOARD SHORTCUTS (was missing / broken)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    const ctrl = e.ctrlKey || e.metaKey;
    if (!ctrl) return;
    switch (e.key.toLowerCase()) {
      case 'g': e.preventDefault(); generate(); break;
      case 'c': if (generatedMsg) { e.preventDefault(); copyMsg(); } break;
      case 'r': e.preventDefault(); regenerate(); break;
      case 'e': e.preventDefault(); editMsg(); break;
      case 's': e.preventDefault(); saveMsg(); break;
      case ',': e.preventDefault(); openModal('modal-settings'); break;
      case 'enter': e.preventDefault(); sendAll(); break;
      case 'shift': break;
    }
    if (ctrl && e.shiftKey && e.key.toLowerCase() === 'r') {
      e.preventDefault(); loadMatches();
    }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// NOTIFICATIONS (was missing)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function toggleNotifications() {
  const btn = document.getElementById('notif-btn');
  if (notificationsEnabled) {
    notificationsEnabled = false;
    btn.classList.remove('on');
    btn.title = 'Enable live notifications';
    toast('Notifications off', 'inf');
    return;
  }
  if ('Notification' in window) {
    const perm = await Notification.requestPermission();
    if (perm === 'granted') {
      notificationsEnabled = true;
      btn.classList.add('on');
      btn.title = 'Notifications on ‚Äî click to disable';
      toast('Live notifications enabled üîî', 'ok');
      new Notification('AutoPost Pro', { body: 'Live goal alerts are now active!', icon: '' });
    } else {
      toast('Notification permission denied', 'err');
    }
  } else {
    toast('Notifications not supported in this browser', 'err');
  }
}

function sendBrowserNotif(title, body) {
  if (notificationsEnabled && Notification.permission === 'granted') {
    new Notification(title, { body });
    document.getElementById('notif-btn').classList.add('has-notif');
    setTimeout(() => document.getElementById('notif-btn').classList.remove('has-notif'), 5000);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AUTO REFRESH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startAutoRefresh() {
  if (refreshInterval) clearInterval(refreshInterval);
  refreshInterval = setInterval(() => {
    updateTicker();
    if (selectedMatchId) {
      const m = allMatches.find(m => m.fixture.id === selectedMatchId);
      if (m && m.fixture.status.short === '1H' || m?.fixture.status.short === '2H') {
        loadEvents();
        loadStats();
        loadScorers();
      }
    }
  }, 30000);
}
function stopAutoRefresh() {
  if (refreshInterval) clearInterval(refreshInterval);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SCHEDULED POST RUNNER (was saving but never executing)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startScheduler() {
  const dotEl = document.getElementById('runner-dot');
  const dotEl2 = document.getElementById('runner-dot2');
  const txtEl = document.getElementById('runner-txt');
  const txtEl2 = document.getElementById('runner-txt2');

  function setRunnerState(active, label) {
    [dotEl, dotEl2].forEach(d => { if (d) { d.className = 'runner-dot' + (active ? ' active' : ''); } });
    [txtEl, txtEl2].forEach(t => { if (t) t.textContent = label; });
  }

  setRunnerState(true, 'Scheduler active');

  schedulerInterval = setInterval(async () => {
    const sched = JSON.parse(localStorage.getItem('ap_scheduled') || '[]');
    const now = new Date();
    let changed = false;

    for (const post of sched) {
      if (post.sent) continue;
      const postTime = new Date(post.datetime);
      if (postTime <= now) {
        // Time to send!
        await executeSendNow(post);
        post.sent = true;
        post.sentAt = new Date().toISOString();
        changed = true;
        sendBrowserNotif('üì§ Scheduled Post Sent', post.title);
        toast(`Scheduled post sent: "${post.title.substring(0,30)}‚Ä¶"`, 'ok');
      }
    }

    if (changed) {
      localStorage.setItem('ap_scheduled', JSON.stringify(sched));
      loadScheduledPosts();
    }
  }, 60000);
}

async function executeSendNow(post) {
  const token = localStorage.getItem('ap_botToken');
  if (!token || !post.message) return;
  const channels = JSON.parse(localStorage.getItem('ap_channels') || '[]');
  if (!channels.length) return;
  for (const ch of channels) {
    try {
      await fetch('/api/telegram/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: ch.chatId, text: post.message, bot_token: token })
      });
    } catch (e) { /* network error, skip */ }
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TICKER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function updateTicker() {
  try {
    const res = await fetch('/api/matches/live');
    const data = await res.json();
    const live = data.matches || [];
    const ticker = document.getElementById('ticker-data');
    if (!live.length) {
      ticker.innerHTML = '<span class="tm-item">‚öΩ No live matches right now</span>'.repeat(3);
      return;
    }
    let html = '';
    for (let i = 0; i < 8; i++) {
      const m = live[i % live.length];
      html += `<span class="tm-item">üî¥ LIVE ${m.teams.home.name} <span class="sc">${m.goals.home}‚Äì${m.goals.away}</span> ${m.teams.away.name} <span style="color:var(--red);font-size:9px;">${m.fixture.status.elapsed || 0}'</span></span>`;
    }
    ticker.innerHTML = html;
  } catch { /* use demo */ }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MATCHES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMatches() {
  const list = document.getElementById('match-list');
  list.innerHTML = '<div class="empty"><span class="sp-sm"></span>Loading matches‚Ä¶</div>';
  try {
    const [liveRes, todayRes] = await Promise.all([
      fetch('/api/matches/live'),
      fetch('/api/matches/today')
    ]);
    const liveData = await liveRes.json();
    const todayData = await todayRes.json();
    const live = liveData.matches || [];
    const today = todayData.matches || [];
    const liveSet = new Set(live.map(m => m.fixture.id));
    allMatches = [...live, ...today.filter(m => !liveSet.has(m.fixture.id))];
    buildLeagueFilter(allMatches);
    renderMatchList(allMatches, liveSet);
    if (allMatches.length) selectMatch(allMatches[0].fixture.id);
  } catch (e) {
    // Demo data fallback
    allMatches = getDemoMatches();
    buildLeagueFilter(allMatches);
    renderMatchList(allMatches, new Set(allMatches.slice(0,2).map(m => m.fixture.id)));
    selectMatch(allMatches[0].fixture.id);
    toast('Using demo data ‚Äî add API key in Settings', 'amber');
  }
}

function getDemoMatches() {
  return [
    { fixture: { id: 1001, date: new Date().toISOString(), status: { short: '2H', elapsed: 67 }, venue: { name: 'Emirates Stadium' } }, league: { id: 39, name: 'Premier League', round: 'Round 28' }, teams: { home: { id: 42, name: 'Arsenal', logo: '' }, away: { id: 66, name: 'Aston Villa', logo: '' } }, goals: { home: 2, away: 1 } },
    { fixture: { id: 1002, date: new Date().toISOString(), status: { short: '1H', elapsed: 33 }, venue: { name: 'Anfield' } }, league: { id: 39, name: 'Premier League', round: 'Round 28' }, teams: { home: { id: 40, name: 'Liverpool', logo: '' }, away: { id: 33, name: 'Manchester United', logo: '' } }, goals: { home: 1, away: 0 } },
    { fixture: { id: 1003, date: new Date(Date.now() + 3600000).toISOString(), status: { short: 'NS', elapsed: null }, venue: { name: 'Etihad Stadium' } }, league: { id: 39, name: 'Premier League', round: 'Round 28' }, teams: { home: { id: 50, name: 'Manchester City', logo: '' }, away: { id: 49, name: 'Chelsea', logo: '' } }, goals: { home: null, away: null } },
    { fixture: { id: 1004, date: new Date(Date.now() + 7200000).toISOString(), status: { short: 'NS', elapsed: null }, venue: { name: 'Santiago Bernab√©u' } }, league: { id: 140, name: 'La Liga', round: 'Round 27' }, teams: { home: { id: 541, name: 'Real Madrid', logo: '' }, away: { id: 529, name: 'FC Barcelona', logo: '' } }, goals: { home: null, away: null } },
    { fixture: { id: 1005, date: new Date(Date.now() - 7200000).toISOString(), status: { short: 'FT', elapsed: 90 }, venue: { name: 'Allianz Arena' } }, league: { id: 78, name: 'Bundesliga', round: 'Round 25' }, teams: { home: { id: 157, name: 'Bayern Munich', logo: '' }, away: { id: 165, name: 'Borussia Dortmund', logo: '' } }, goals: { home: 3, away: 2 } },
  ];
}

function buildLeagueFilter(matches) {
  const leagues = [...new Set(matches.map(m => m.league.name))];
  const sel = document.getElementById('league-filter');
  sel.innerHTML = '<option value="">All</option>' + leagues.map(l => `<option value="${l}">${l}</option>`).join('');
}

function filterByLeague(league) {
  const filtered = !league ? allMatches : allMatches.filter(m => m.league.name === league);
  const liveSet = new Set(allMatches.filter(m => m.fixture.status.short === '1H' || m.fixture.status.short === '2H').map(m => m.fixture.id));
  renderMatchList(filtered, liveSet);
}

function renderMatchList(matches, liveSet) {
  const list = document.getElementById('match-list');
  if (!matches.length) {
    list.innerHTML = '<div class="empty">No fixtures found</div>';
    return;
  }
  let lastLeague = '';
  let html = '';
  matches.forEach(m => {
    const league = m.league.name;
    if (league !== lastLeague) {
      html += `<div class="league-hdr">${league}</div>`;
      lastLeague = league;
    }
    const isLive = liveSet && liveSet.has(m.fixture.id);
    const score = m.goals.home !== null ? `${m.goals.home}‚Äì${m.goals.away}` : 'vs';
    const status = m.fixture.status;
    const time = isLive
      ? `<span class="tag-live"><span class="p"></span>LIVE</span> ${status.elapsed || 0}'`
      : status.short === 'FT' ? '<span class="tag-ft">FT</span>'
      : `<span class="tag-sch">${new Date(m.fixture.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;
    const selClass = selectedMatchId === m.fixture.id ? ' sel' : '';
    html += `<div class="match-row${selClass}" onclick="selectMatch(${m.fixture.id})" id="mi-${m.fixture.id}">
      <div class="mr-top"><span class="mr-home">${m.teams.home.name}</span><span class="mr-score">${score}</span><span class="mr-away">${m.teams.away.name}</span></div>
      <div class="mr-bot">${time} ¬∑ ${m.fixture.venue?.name || m.league.round || ''}</div>
    </div>`;
  });
  list.innerHTML = html;
}

function selectMatch(id) {
  document.querySelectorAll('.match-row').forEach(r => r.classList.remove('sel'));
  const el = document.getElementById('mi-' + id);
  if (el) el.classList.add('sel');
  selectedMatchId = id;
  const m = allMatches.find(m => m.fixture.id === id);
  if (!m) return;
  const score = m.goals.home !== null ? `${m.goals.home}‚Äì${m.goals.away}` : 'vs';
  const status = m.fixture.status;

  // Right col
  document.getElementById('fc-home').textContent = m.teams.home.name;
  document.getElementById('fc-away').textContent = m.teams.away.name;
  document.getElementById('fc-score').textContent = score;
  document.getElementById('fc-league').textContent = `${m.league.name} ¬∑ ${m.league.round || ''}`;
  document.getElementById('fc-min').textContent = status.elapsed ? `‚óè ${status.elapsed}'` : status.short === 'FT' ? 'FT' : '';

  // Mid stats/events
  document.getElementById('st-home').textContent = m.teams.home.name;
  document.getElementById('st-away').textContent = m.teams.away.name;
  document.getElementById('st-score').textContent = score;
  document.getElementById('st-min').textContent = status.elapsed ? `‚óè ${status.elapsed}'` : status.short === 'FT' ? 'FT' : '';
  document.getElementById('ev-score').textContent = `${m.teams.home.name} ${score} ${m.teams.away.name}`;
  document.getElementById('ev-info').textContent = `${m.league.name} ¬∑ ${status.elapsed ? status.elapsed + "'" : status.short === 'FT' ? 'FT' : new Date(m.fixture.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`;

  loadEvents();
  loadStats();
  loadScorers();
}

function filterBy(f) {
  document.getElementById('f-all').classList.toggle('on', f === 'all');
  document.getElementById('f-live').classList.toggle('on', f === 'live');
  document.querySelectorAll('.match-row').forEach(r => {
    const hasLive = !!r.querySelector('.tag-live');
    r.style.display = (f === 'live' && !hasLive) ? 'none' : '';
  });
}

function searchMatches(q) {
  document.querySelectorAll('#match-list .match-row, #match-list .league-hdr').forEach(r => {
    if (r.classList.contains('league-hdr')) { r.style.display = ''; return; }
    const txt = r.textContent.toLowerCase();
    r.style.display = (!q || txt.includes(q.toLowerCase())) ? '' : 'none';
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EVENTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadEvents() {
  if (!selectedMatchId) return;
  const list = document.getElementById('ev-list');
  list.innerHTML = '<div class="empty"><span class="sp-sm"></span>Loading events‚Ä¶</div>';
  try {
    const res = await fetch(`/api/matches/events?fixture=${selectedMatchId}`);
    const data = await res.json();
    const events = data.events || [];
    if (!events.length) {
      list.innerHTML = '<div class="empty">No events yet</div>';
      return;
    }
    list.innerHTML = events
      .filter(e => e.type === 'Goal' || e.type === 'Card' || e.type === 'subst')
      .map(e => {
        const icon = e.type === 'Goal' ? '‚öΩ' : e.detail === 'Red Card' ? 'üü•' : e.type === 'subst' ? 'üîÑ' : 'üü®';
        const evType = e.type === 'Goal' ? 'goal' : e.detail === 'Red Card' ? 'red' : 'yellow';
        return `<div class="ev-item">
          <span class="ev-min">${e.minute}${e.extra_minute ? '+' + e.extra_minute : ''}'</span>
          <span class="ev-icon">${icon}</span>
          <div class="ev-detail">
            <div class="ev-player">${e.player || ''}</div>
            <div class="ev-team">${e.team_name || ''} ${e.type === 'Goal' && e.assist ? '¬∑ Assist: ' + e.assist : ''}</div>
          </div>
          <button class="action-btn ev-post-btn" onclick="quickPost('${evType}','${(e.player || '').replace(/'/g,"\\'")}',${e.minute},'${(e.team_name || '').replace(/'/g,"\\'")}')">‚ú¶ Post</button>
        </div>`;
      }).join('');
  } catch {
    // demo events
    list.innerHTML = `<div class="ev-item"><span class="ev-min">23'</span><span class="ev-icon">‚öΩ</span><div class="ev-detail"><div class="ev-player">Demo Player</div><div class="ev-team">Home Team ¬∑ Assist: Demo Assist</div></div><button class="action-btn ev-post-btn" onclick="quickPost('goal','Demo Player',23,'Home Team')">‚ú¶ Post</button></div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStats() {
  if (!selectedMatchId) return;
  const list = document.getElementById('stats-list');
  list.innerHTML = '<div class="empty"><span class="sp-sm"></span>Loading stats‚Ä¶</div>';
  try {
    const res = await fetch(`/api/matches/stats?fixture=${selectedMatchId}`);
    const data = await res.json();
    const stats = data.stats || [];
    if (!stats.length) { renderDemoStats(list); return; }
    const home = stats[0]?.statistics || [];
    const away = stats[1]?.statistics || [];
    const statMap = (arr, type) => { const f = arr.find(s => s.type === type); return f ? f.value : '0'; };
    const rows = [
      { label: 'Possession', key: 'Ball Possession' },
      { label: 'Shots on Target', key: 'Shots on Goal' },
      { label: 'Total Shots', key: 'Total Shots' },
      { label: 'Corners', key: 'Corners' },
      { label: 'Fouls', key: 'Fouls' },
      { label: 'Yellow Cards', key: 'Yellow Cards' },
      { label: 'Offsides', key: 'Offsides' },
      { label: 'Passes (Acc.)', key: 'Passes accurate' },
    ];
    list.innerHTML = rows.map(r => {
      const hv = statMap(home, r.key), av = statMap(away, r.key);
      const hNum = parseInt(hv) || 0, aNum = parseInt(av) || 0;
      const total = hNum + aNum;
      const hp = total ? (hNum / total) * 100 : 50;
      const ap = total ? (aNum / total) * 100 : 50;
      return `<div class="stat-row">
        <div class="stat-lbl"><span class="v1">${hv}</span><span>${r.label}</span><span class="v2">${av}</span></div>
        <div class="stat-track"><div class="stat-left" style="--w:${hp}%;"></div><div class="stat-right" style="--w:${ap}%;"></div></div>
      </div>`;
    }).join('');
  } catch { renderDemoStats(list); }
}

function renderDemoStats(list) {
  const rows = [
    { label: 'Possession', hv: '58%', av: '42%', hp: 58 },
    { label: 'Shots on Target', hv: '7', av: '3', hp: 70 },
    { label: 'Total Shots', hv: '14', av: '8', hp: 64 },
    { label: 'Corners', hv: '6', av: '2', hp: 75 },
    { label: 'Fouls', hv: '9', av: '12', hp: 43 },
  ];
  list.innerHTML = rows.map(r => `
    <div class="stat-row">
      <div class="stat-lbl"><span class="v1">${r.hv}</span><span>${r.label}</span><span class="v2">${r.av}</span></div>
      <div class="stat-track"><div class="stat-left" style="--w:${r.hp}%;"></div><div class="stat-right" style="--w:${100-r.hp}%;"></div></div>
    </div>`).join('');
}

async function loadScorers() {
  if (!selectedMatchId) return;
  const list = document.getElementById('scorers-list');
  try {
    const res = await fetch(`/api/matches/events?fixture=${selectedMatchId}`);
    const data = await res.json();
    const goals = (data.events || []).filter(e => e.type === 'Goal');
    if (!goals.length) {
      list.innerHTML = `<div class="scorer-row" style="justify-content:center;"><span style="color:var(--dim);font-family:var(--mono);font-size:10px;">No goals yet</span></div>`;
      return;
    }
    const m = allMatches.find(m => m.fixture.id === selectedMatchId);
    list.innerHTML = goals.map(g => `
      <div class="scorer-row">
        <div class="sr-left"><span>‚öΩ</span><span class="sr-name">${g.player || 'Unknown'}</span><span class="sr-min">${g.minute}'</span></div>
        <span class="sr-team" style="color:${g.team_name === m?.teams.home.name ? 'var(--volt)' : 'var(--sky)'};">${g.team_name}</span>
      </div>`).join('');
  } catch {
    list.innerHTML = `<div class="scorer-row" style="justify-content:center;"><span style="color:var(--dim);font-family:var(--mono);font-size:10px;">Demo: No scorers</span></div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FIXTURES (now with date picker)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFixtures() {
  const list = document.getElementById('fixtures-list');
  const dateVal = document.getElementById('fixture-date').value;
  list.innerHTML = '<div class="empty"><span class="sp-sm"></span>Loading fixtures‚Ä¶</div>';
  try {
    const res = await fetch(`/api/matches/today${dateVal ? '?date=' + dateVal : ''}`);
    const data = await res.json();
    renderFixtures(data.matches || []);
  } catch {
    renderFixtures(getDemoMatches());
  }
}

function renderFixtures(matches) {
  const list = document.getElementById('fixtures-list');
  if (!matches.length) {
    list.innerHTML = '<div class="empty">No fixtures for this date</div>';
    return;
  }
  let lastLeague = '', html = '';
  matches.forEach(m => {
    const league = m.league.name;
    if (league !== lastLeague) { html += `<div class="league-hdr">${league}</div>`; lastLeague = league; }
    const time = new Date(m.fixture.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const score = m.goals.home !== null ? `${m.goals.home}‚Äì${m.goals.away}` : '‚Äì';
    const status = m.fixture.status;
    const statusBadge = status.short === 'FT' ? '<span class="tag-ft" style="font-size:9px;">FT</span>' :
      (status.elapsed ? `<span class="tag-live" style="font-size:8px;"><span class="p"></span>LIVE ${status.elapsed}'</span>` : '');
    html += `<div class="fix-item">
      <span class="fix-time">${time} ${statusBadge}</span>
      <span class="fix-teams">${m.teams.home.name}<span class="sep">vs</span>${m.teams.away.name}</span>
      <span class="fix-score">${score}</span>
      <div class="fix-acts">
        <button class="action-btn" onclick="selectMatch(${m.fixture.id});switchMid('message',null);setTimeout(generate,100)">‚ú¶ AI</button>
        <button class="action-btn" onclick="copyFixtureLine('${m.teams.home.name}','${m.teams.away.name}','${score}','${time}')">üìã</button>
      </div>
    </div>`;
  });
  list.innerHTML = html;
}

function copyFixtureLine(h, a, sc, time) {
  navigator.clipboard.writeText(`${time} | ${h} ${sc} ${a}`).then(() => toast('Copied!', 'ok'));
}

function copyAllFixtures() {
  let out = "üìã FIXTURES\n" + "‚îÅ".repeat(28) + "\n\n";
  document.querySelectorAll('#fixtures-list .league-hdr, #fixtures-list .fix-item').forEach(el => {
    if (el.classList.contains('league-hdr')) out += `\n${el.textContent.trim()}\n`;
    else {
      const teams = el.querySelector('.fix-teams')?.textContent.replace(/\s+/g,' ').trim() || '';
      const score = el.querySelector('.fix-score')?.textContent.trim() || '';
      const time  = el.querySelector('.fix-time')?.textContent.trim() || '';
      out += `  ${time.substring(0,5).padEnd(8)} ${teams.replace(' vs ', ' ‚Äì ')} ¬∑ ${score}\n`;
    }
  });
  navigator.clipboard.writeText(out).then(() => toast('All fixtures copied!', 'ok'));
}

function genDigest() {
  setType('digest', document.querySelectorAll('.ttab')[3]);
  switchMid('message', null);
  generate();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GENERATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generate() {
  const ph  = document.getElementById('msg-ph');
  const txt = document.getElementById('msg-txt');
  const ov  = document.getElementById('gen-overlay');
  const btn = document.getElementById('gen-btn');
  const st  = document.getElementById('gen-status');
  const bar = document.getElementById('copy-bar');

  switchMid('message', null);
  ph.style.display  = 'none';
  txt.style.display = 'none';
  ov.style.display  = 'flex';
  bar.style.display = 'none';
  document.getElementById('hashtag-strip').style.display = 'none';
  btn.disabled = true;
  btn.innerHTML = '<span class="sp-sm"></span> GENERATING‚Ä¶';

  const statuses = ['Fetching live data‚Ä¶','Analysing events‚Ä¶','Applying tone‚Ä¶','Building narrative‚Ä¶','Finalising message‚Ä¶'];
  let si = 0;
  const interval = setInterval(() => {
    st.textContent = statuses[si % statuses.length];
    document.getElementById('gen-sub').textContent = ['', 'Processing stats‚Ä¶', '', 'Checking H2H‚Ä¶', ''][si % 5];
    si++;
  }, 1100);

  try {
    const aff = JSON.parse(localStorage.getItem('ap_affiliate') || '{}');
    const payload = {
      message_type: currentType,
      tone: document.getElementById('tone').value,
      length: document.getElementById('length').value,
      language: document.getElementById('lang').value,
      include_stats: document.getElementById('inc-stats').checked,
      include_players: document.getElementById('inc-players').checked,
      include_h2h: document.getElementById('inc-h2h').checked,
      include_emojis: document.getElementById('inc-emojis').checked,
      include_hashtags: document.getElementById('inc-hashtags').checked,
      template: currentTpl,
      prediction_type: predictionType,
      custom_prompt: document.getElementById('custom-txt')?.value || '',
    };
    if (aff.url && document.getElementById('inc-aff').checked)
      payload.affiliate_line = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n${aff.label || 'üîó Support us'} ‚Üí ${aff.url}`;

    const m = allMatches.find(m => m.fixture.id === selectedMatchId);
    if (m && ['live','preview','prediction'].includes(currentType)) payload.match_data = m;

    if (currentType === 'standings') {
      const leagueId = document.getElementById('standings-league').value;
      const sRes = await fetch(`/api/standings?league=${leagueId}&season=2024`);
      const sData = await sRes.json();
      payload.standings_data = sData.standings?.[0]?.league?.standings?.[0] || [];
    } else if (currentType === 'digest') {
      const fRes = await fetch('/api/matches/today');
      const fData = await fRes.json();
      payload.fixtures_data = fData.matches || [];
    }

    const genRes = await fetch('/api/ai/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const genData = await genRes.json();
    generatedMsg = genData.message;
  } catch {
    await new Promise(r => setTimeout(r, 1600));
    const m = allMatches.find(m => m.fixture.id === selectedMatchId);
    generatedMsg = buildDemoMessage(m);
  }

  clearInterval(interval);
  finishGenerate();
}

function buildDemoMessage(m) {
  const name1 = m?.teams.home.name || 'Home Team';
  const name2 = m?.teams.away.name || 'Away Team';
  const score = m?.goals.home !== null ? `${m.goals.home}‚Äì${m.goals.away}` : '';
  const league = m?.league.name || 'League';
  const elapsed = m?.fixture.status.elapsed;

  const msgs = {
    live: `üî¥ LIVE: ${name1} ${score} ${name2}\n${elapsed ? `‚è±Ô∏è ${elapsed} minutes played` : ''}\n\nüìä Match stats: Strong pressure from both sides. Possession split evenly.\n\nüåü Key moment: Brilliant save keeps scoreline tight!\n\n${league} | Follow for live updates üö®`,
    preview: `üìÖ MATCH PREVIEW\n${name1} üÜö ${name2}\n${league}\n\nüîç Form Analysis:\n${name1} ‚Üí 4W 1D in last 5\n${name2} ‚Üí 3W 1D 1L in last 5\n\n‚ö° Key Battle: Midfield control\nüéØ Prediction: High-scoring match expected\n\nüèüÔ∏è Who do you think wins? Comment below!`,
    fulltime: `üèÅ FULL TIME\n${name1} ${score} ${name2}\n\n${league}\n\nüìä This was a thrilling encounter with both teams showing great quality. Fans were treated to excellent football throughout.\n\nüåü Man of the Match: Outstanding individual performance deserved recognition tonight!`,
    standings: `üèÜ TABLE UPDATE\n${league}\n\n1. Leader FC ‚Äî 58pts ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà\n2. ${name1} ‚Äî 55pts ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà\n3. ${name2} ‚Äî 52pts ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà\n4. Rival United ‚Äî 49pts ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà\n\nüìà The title race is heating up! Three teams within 6 points with 10 games left.`,
    digest: `üìä FOOTBALL DAILY DIGEST\n${'‚îÅ'.repeat(26)}\n\nToday's action across Europe's top leagues:\n\n‚öΩ ${name1} ${score || 'vs'} ${name2} ‚Äî ${elapsed ? elapsed + "'" : 'Upcoming'}\n‚öΩ Liverpool 2‚Äì1 Man United ‚Äî FT\n‚öΩ Real Madrid 3‚Äì0 Atletico ‚Äî FT\n\nüî• Top scorer today: C. Ronaldo (87')\nüìà Biggest upset: Ajax 0‚Äì3 Young Boys\n\nFollow for live scores! üöÄ`,
    prediction: `üîÆ MATCH PREDICTION\n${name1} vs ${name2}\n${league}\n\nüéØ Our Pick: Both Teams to Score (BTTS) ‚úÖ\nüìä Confidence: 78%\n\nüîç Based on:\n‚Ä¢ Both teams avg 1.8 goals scored/game\n‚Ä¢ Head-to-head: 4/5 last meetings had BTTS\n‚Ä¢ No injury concerns for key attackers\n\n‚ö†Ô∏è Gamble responsibly. 18+ only.`,
    custom: `‚ú¶ Custom message generated.\n\n${name1} vs ${name2} ‚Äî ${league}\n\nYour custom prompt has been processed. In production, the AI will follow your specific instructions.`,
  };
  return msgs[currentType] || msgs.live;
}

function finishGenerate() {
  const btn = document.getElementById('gen-btn');
  const txt = document.getElementById('msg-txt');
  const ov  = document.getElementById('gen-overlay');
  const bar = document.getElementById('copy-bar');

  ov.style.display = 'none';
  btn.disabled = false;
  btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> GENERATE MESSAGE <kbd>‚åòG</kbd>`;

  txt.textContent = generatedMsg;
  txt.className = 'msg-generated';
  txt.style.display = 'block';

  const ts = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  document.getElementById('gen-ts').textContent = ts;
  document.getElementById('msg-footer-l').textContent = 'Generated ¬∑ ready to send';
  bar.style.display = 'flex';

  // Update character counts
  updateCharCounts(generatedMsg.length);

  // Auto hashtags if enabled
  if (document.getElementById('inc-hashtags').checked) {
    generateHashtags();
  }

  // Schedule preview
  document.getElementById('sched-msg-preview').value = generatedMsg.substring(0,200);

  saveToHistory(generatedMsg);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CHARACTER COUNTS & PLATFORM LIMITS (was missing)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCharCounts(len) {
  document.getElementById('char-count').textContent = `${len} chars`;

  const platforms = {
    twitter: { limit: 280, id: 'pl-twitter', countId: 'plc-twitter' },
    telegram: { limit: 4096, id: 'pl-telegram', countId: 'plc-telegram' },
    whatsapp: { limit: 65536, id: 'pl-whatsapp', countId: 'plc-whatsapp' },
    instagram: { limit: 2200, id: 'pl-instagram', countId: 'plc-instagram' },
  };
  for (const [key, p] of Object.entries(platforms)) {
    const remaining = p.limit - len;
    const el = document.getElementById(p.id);
    const countEl = document.getElementById(p.countId);
    if (!el || !countEl) continue;
    if (remaining < 0) {
      countEl.textContent = `${Math.abs(remaining)} over`;
      countEl.className = 'plat-count char-over';
      el.style.borderColor = 'rgba(255,69,69,.3)';
    } else if (remaining < p.limit * 0.1) {
      countEl.textContent = `${remaining} left`;
      countEl.className = 'plat-count char-warn';
      el.style.borderColor = 'rgba(255,176,32,.3)';
    } else {
      countEl.textContent = `${remaining} left`;
      countEl.className = 'plat-count char-ok';
      el.style.borderColor = '';
    }
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// HASHTAG GENERATOR (was missing)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateHashtags() {
  const m = allMatches.find(m => m.fixture.id === selectedMatchId);
  if (!m) return;
  const tags = new Set();
  const home = m.teams.home.name.replace(/\s+/g,'');
  const away = m.teams.away.name.replace(/\s+/g,'');
  const league = m.league.name.replace(/\s+/g,'');
  tags.add(`#${home}`);
  tags.add(`#${away}`);
  tags.add(`#${league}`);
  tags.add('#Football');
  tags.add('#Soccer');
  if (currentType === 'live') tags.add('#LiveFootball');
  if (currentType === 'preview') tags.add('#MatchPreview');
  if (currentType === 'prediction') tags.add('#Prediction');
  if (m.league.name.includes('Premier')) { tags.add('#PL'); tags.add('#PremierLeague'); }
  if (m.league.name.includes('Champions')) tags.add('#UCL');
  if (m.league.name.includes('La Liga')) tags.add('#LaLiga');
  const tagArr = [...tags].slice(0, 10);
  renderHashtags(tagArr);
}

function renderHashtags(tags) {
  const strip = document.getElementById('hashtag-strip');
  const container = document.getElementById('hashtag-tags');
  strip.style.display = 'block';
  container.innerHTML = tags.map(t => `<span class="hashtag-tag" onclick="toggleHashtag(this,'${t}')">${t}</span>`).join('');
}

function showHashtags() {
  if (!generatedMsg) { toast('Generate a message first', 'err'); return; }
  generateHashtags();
  toast('Hashtags generated!', 'volt');
}

function toggleHashtag(el, tag) {
  el.classList.toggle('added');
  if (el.classList.contains('added')) {
    generatedMsg += '\n' + tag;
  } else {
    generatedMsg = generatedMsg.replace('\n' + tag, '').replace(' ' + tag, '');
  }
  document.getElementById('msg-txt').textContent = generatedMsg;
  updateCharCounts(generatedMsg.length);
}

function appendAllHashtags() {
  document.querySelectorAll('.hashtag-tag:not(.added)').forEach(t => t.click());
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// QUICK POSTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function quickPost(type, player, minute, team) {
  if (!selectedMatchId) { toast('Select a match first', 'err'); return; }
  const m = allMatches.find(m => m.fixture.id === selectedMatchId);
  if (!m) return;
  const h = m.teams.home.name, a = m.teams.away.name;
  const sc = `${m.goals.home ?? 0}‚Äì${m.goals.away ?? 0}`;
  const templates = {
    goal: `‚öΩ GOAL! ${minute ? minute + "'" : ''}\n${player ? player.toUpperCase() : 'GOAL!'} scores for ${team}!\n${h} ${sc} ${a}\n\n${m.league.name}`,
    halftime: `üîî HALF TIME\n${h} ${sc} ${a}\n${m.league.name}\n\nüìä Stats analysis coming up. What do you think of the first half?`,
    fulltime: `üèÅ FULL TIME\n${h} ${sc} ${a}\n${m.league.name}\n\nMatch report coming up! üìä`,
    red: `üü• RED CARD! ${minute ? minute + "'" : ''}\n${player || 'A player'} is sent off!\n${team} reduced to 10 men.\n${h} ${sc} ${a}`,
    yellow: `üü® YELLOW CARD ${minute ? minute + "'" : ''}\n${player || 'Player'} receives a booking.\n${h} ${sc} ${a}`,
    penalty: `üéØ PENALTY AWARDED!\n${h} ${sc} ${a}\nThe referee points to the spot ‚Äî ${team ? team + ' to take it' : ''}!`,
    var: `üì∫ VAR CHECK IN PROGRESS\n${h} ${sc} ${a}\nüîç Referee reviewing the decision‚Ä¶`,
    kickoff: `üèüÔ∏è KICK OFF!\n${h} vs ${a}\n${m.league.name} ‚Äî Here we go! üî•`,
    injury: `üöë INJURY CONCERN\n${h} ${sc} ${a}\n${player || 'A player'} is down receiving treatment.`,
    summary: `üî¥ LIVE UPDATE\n${h} ${sc} ${a}\n${m.fixture.status.elapsed ? m.fixture.status.elapsed + "' played" : ''}\n${m.league.name}`,
  };
  generatedMsg = templates[type] || templates.summary;
  showGeneratedMsg(generatedMsg);
  switchMid('message', null);
  toast('Quick post ready! ‚úì', 'volt');
  if (notificationsEnabled) sendBrowserNotif('‚ö° AutoPost Ready', `${type} post generated for ${h} vs ${a}`);
}

function showGeneratedMsg(msg) {
  document.getElementById('msg-txt').textContent = msg;
  document.getElementById('msg-txt').style.display = 'block';
  document.getElementById('msg-ph').style.display = 'none';
  document.getElementById('copy-bar').style.display = 'flex';
  document.getElementById('gen-ts').textContent = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  document.getElementById('msg-footer-l').textContent = 'Quick post ready';
  updateCharCounts(msg.length);
  document.getElementById('sched-msg-preview').value = msg.substring(0, 200);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SEND & COPY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendAll() {
  if (!generatedMsg) { toast('Generate a message first', 'err'); return; }
  const token = localStorage.getItem('ap_botToken');
  if (!token || token.length < 10) {
    openModal('modal-settings');
    toast('Set your bot token in Settings first', 'err');
    return;
  }
  const channels = JSON.parse(localStorage.getItem('ap_channels') || '[]');
  const selected = [...document.querySelectorAll('.ch-cb:checked')].map(cb => channels[+cb.value]).filter(Boolean);
  if (!selected.length) { toast('Select at least one channel', 'err'); return; }
  const btn = document.getElementById('send-tg-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="sp-sm"></span> SENDING‚Ä¶';
  let sent = 0, failed = 0;
  for (const ch of selected) {
    try {
      const r = await fetch('/api/telegram/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: ch.chatId, text: generatedMsg, bot_token: token })
      });
      if ((await r.json()).ok) {
        sent++;
        markLastHistoryAsSent();
      } else { failed++; }
    } catch { failed++; }
  }
  btn.disabled = false;
  btn.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> SEND TO TELEGRAM`;
  if (sent > 0) { toast(`‚úì Sent to ${sent} channel${sent > 1 ? 's' : ''}${failed ? `, ${failed} failed` : ''}`, 'ok'); }
  else { toast('Send failed ‚Äî check bot token & channel IDs', 'err'); }
}

function copyMsg() {
  if (!generatedMsg) { toast('Nothing to copy yet', 'err'); return; }
  navigator.clipboard.writeText(generatedMsg)
    .then(() => toast('Copied! ‚úì', 'ok'))
    .catch(() => {
      // Fallback for older browsers
      const ta = document.createElement('textarea');
      ta.value = generatedMsg;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      toast('Copied! ‚úì', 'ok');
    });
}

// WhatsApp deep link (was missing)
function openWhatsApp() {
  if (!generatedMsg) { toast('Generate a message first', 'err'); return; }
  const encoded = encodeURIComponent(generatedMsg);
  window.open(`https://wa.me/?text=${encoded}`, '_blank');
}

// Twitter/X deep link (was missing)
function openTwitter() {
  if (!generatedMsg) { toast('Generate a message first', 'err'); return; }
  const text = generatedMsg.length > 280 ? generatedMsg.substring(0, 277) + '‚Ä¶' : generatedMsg;
  const encoded = encodeURIComponent(text);
  window.open(`https://twitter.com/intent/tweet?text=${encoded}`, '_blank');
}

function selAllCh(v) { document.querySelectorAll('.ch-cb').forEach(cb => cb.checked = v); }

function regenerate() { generate(); }

function editMsg() {
  const txt = document.getElementById('msg-txt');
  const btn = document.getElementById('edit-btn');
  if (txt.contentEditable === 'true') {
    txt.contentEditable = 'false';
    generatedMsg = txt.textContent;
    btn.innerHTML = '‚úèÔ∏è Edit';
    updateCharCounts(generatedMsg.length);
    toast('Edits saved ‚úì', 'ok');
  } else {
    txt.contentEditable = 'true';
    txt.focus();
    btn.innerHTML = '‚úì Done';
  }
}

function saveMsg() {
  if (!generatedMsg) { toast('Nothing to save', 'err'); return; }
  saveToHistory(generatedMsg);
  toast('Saved to history ‚úì', 'ok');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CHANNELS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadChannelsFromStorage() {
  const channels = JSON.parse(localStorage.getItem('ap_channels') || '[]');
  const el = document.getElementById('ch-list');
  if (!channels.length) {
    el.innerHTML = `<div class="empty" style="padding:10px 0;font-size:11px;">No channels. <a href="#" onclick="openModal('modal-channel');return false;">Add one ‚Üí</a></div>`;
    return;
  }
  el.innerHTML = channels.map((ch, i) => `
    <div class="ch-row">
      <label><input type="checkbox" class="ch-cb" value="${i}" checked>üì¢ ${ch.name}</label>
      <span class="ch-cid">${ch.chatId}</span>
      <button class="mb red" onclick="removeChannel(${i})" style="padding:1px 6px;font-size:9px;">‚úï</button>
    </div>`).join('');

  // Update selects in modals
  const chOptions = channels.map(c => `<option>${c.name}</option>`).join('');
  document.getElementById('auto-channels').innerHTML = '<option>All channels</option>' + chOptions;
  document.getElementById('sched-channels').innerHTML = '<option>All selected channels</option>' + chOptions;
}

function addChannel() {
  const name = document.getElementById('new-ch-name').value.trim();
  const id   = document.getElementById('new-ch-id').value.trim();
  if (!name || !id) { toast('Fill in both fields', 'err'); return; }
  if (!id.startsWith('-') && !id.startsWith('@')) { toast('Channel ID usually starts with -100‚Ä¶', 'amber'); }
  const channels = JSON.parse(localStorage.getItem('ap_channels') || '[]');
  if (channels.find(c => c.chatId === id)) { toast('Channel already added', 'err'); return; }
  channels.push({ name, chatId: id });
  localStorage.setItem('ap_channels', JSON.stringify(channels));
  document.getElementById('new-ch-name').value = '';
  document.getElementById('new-ch-id').value = '';
  loadChannelsFromStorage();
  closeModal('modal-channel');
  toast(`${name} connected! ‚úì`, 'ok');
}

function removeChannel(i) {
  const channels = JSON.parse(localStorage.getItem('ap_channels') || '[]');
  const name = channels[i]?.name;
  channels.splice(i, 1);
  localStorage.setItem('ap_channels', JSON.stringify(channels));
  loadChannelsFromStorage();
  toast(`${name} removed`, 'inf');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// HISTORY (with mark-as-sent + export)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveToHistory(msg) {
  if (!msg) return;
  const posts = JSON.parse(localStorage.getItem('ap_posts') || '[]');
  const m = allMatches.find(m => m.fixture.id === selectedMatchId);
  const title = m ? `${m.teams.home.name} vs ${m.teams.away.name} ¬∑ ${currentType}` : `${currentType} post`;
  posts.unshift({ id: Date.now(), title, preview: msg.substring(0, 80), message: msg, timestamp: new Date().toISOString(), sent: false });
  localStorage.setItem('ap_posts', JSON.stringify(posts.slice(0, 50)));
  loadHistoryFromStorage();
}

function markLastHistoryAsSent() {
  const posts = JSON.parse(localStorage.getItem('ap_posts') || '[]');
  if (posts.length) { posts[0].sent = true; posts[0].sentAt = new Date().toISOString(); }
  localStorage.setItem('ap_posts', JSON.stringify(posts));
  loadHistoryFromStorage();
}

function loadHistoryFromStorage() {
  const posts = JSON.parse(localStorage.getItem('ap_posts') || '[]');
  const el = document.getElementById('hist-list');
  if (!posts.length) {
    el.innerHTML = '<div class="empty">No history yet</div>';
    return;
  }
  el.innerHTML = posts.slice(0, 30).map((p, i) => `
    <div class="hist-item" onclick="loadHistoryMsg(${i})">
      <button class="hi-del" onclick="event.stopPropagation();deleteHistoryItem(${i})">‚úï</button>
      <div class="hi-top">
        <span class="hi-title">${p.title || 'Message'}</span>
        <span class="hi-time">${new Date(p.timestamp).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span>
      </div>
      <div class="hi-prev">${(p.preview||'').substring(0,65)}‚Ä¶</div>
      <div class="hi-tags">
        <span class="hi-tag">${p.title?.split(' ¬∑ ')[1] || 'message'}</span>
        ${p.sent ? '<span class="hi-tag hi-sent">‚úì Sent</span>' : ''}
      </div>
    </div>`).join('');
}

function loadHistoryMsg(i) {
  const posts = JSON.parse(localStorage.getItem('ap_posts') || '[]');
  const p = posts[i];
  if (!p) return;
  generatedMsg = p.message || p.preview;
  showGeneratedMsg(generatedMsg);
  switchMid('message', null);
}

function deleteHistoryItem(i) {
  const posts = JSON.parse(localStorage.getItem('ap_posts') || '[]');
  posts.splice(i, 1);
  localStorage.setItem('ap_posts', JSON.stringify(posts));
  loadHistoryFromStorage();
}

function clearHistory() {
  if (!confirm('Clear all message history?')) return;
  localStorage.removeItem('ap_posts');
  document.getElementById('hist-list').innerHTML = '<div class="empty">History cleared</div>';
  toast('History cleared', 'inf');
}

function exportHistory() {
  const posts = JSON.parse(localStorage.getItem('ap_posts') || '[]');
  if (!posts.length) { toast('No history to export', 'err'); return; }
  let txt = 'AutoPost Pro ‚Äî Message History Export\n' + '='.repeat(40) + '\n\n';
  posts.forEach((p, i) => {
    txt += `[${i+1}] ${p.title}\n${new Date(p.timestamp).toLocaleString()}\n${p.sent ? '‚úì SENT' : 'NOT SENT'}\n${'‚îÄ'.repeat(30)}\n${p.message}\n\n`;
  });
  const blob = new Blob([txt], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'autopost-history.txt';
  a.click();
  toast('History exported ‚úì', 'ok');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AUTOMATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadAutoRules() {
  const rules = JSON.parse(localStorage.getItem('ap_auto_rules') || '[]');
  const list = document.getElementById('auto-list');
  if (!rules.length) {
    list.innerHTML = '<div class="empty">No automation rules yet.<br>Create rules to auto-post on goal alerts, HT, FT, etc.</div>';
    return;
  }
  list.innerHTML = rules.map((r, i) => `
    <div class="auto-item">
      <div class="auto-info">
        <div class="auto-name">${r.name}</div>
        <div class="auto-desc">${r.trigger || 'Custom trigger'} ¬∑ ${r.league || 'All leagues'} ¬∑ ${r.tone || 'Excited'}</div>
      </div>
      <button class="auto-badge ${r.on ? 'ab-on' : 'ab-off'}" onclick="toggleAuto(this, ${i})">${r.on ? 'ON' : 'OFF'}</button>
      <button class="mb red" onclick="deleteAutoRule(${i})" style="margin-left:4px;">‚úï</button>
    </div>`).join('');
}

function toggleAuto(btn, idx) {
  const rules = JSON.parse(localStorage.getItem('ap_auto_rules') || '[]');
  rules[idx].on = !rules[idx].on;
  localStorage.setItem('ap_auto_rules', JSON.stringify(rules));
  btn.className = `auto-badge ${rules[idx].on ? 'ab-on' : 'ab-off'}`;
  btn.textContent = rules[idx].on ? 'ON' : 'OFF';
  toast(rules[idx].on ? 'Rule activated ‚úì' : 'Rule paused', rules[idx].on ? 'ok' : 'inf');
}

function addAutoRule() {
  const name = document.getElementById('auto-name').value.trim() || 'New Rule';
  const trigger = document.getElementById('auto-trigger').value;
  const league = document.getElementById('auto-league').value;
  const tone = document.getElementById('auto-tone').value;
  const rules = JSON.parse(localStorage.getItem('ap_auto_rules') || '[]');
  rules.push({ name, trigger, league, tone, on: true, createdAt: new Date().toISOString() });
  localStorage.setItem('ap_auto_rules', JSON.stringify(rules));
  document.getElementById('auto-name').value = '';
  loadAutoRules();
  closeModal('modal-auto');
  toast('Automation rule created! ‚úì', 'volt');
}

function deleteAutoRule(i) {
  const rules = JSON.parse(localStorage.getItem('ap_auto_rules') || '[]');
  rules.splice(i, 1);
  localStorage.setItem('ap_auto_rules', JSON.stringify(rules));
  loadAutoRules();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SCHEDULED POSTS (now with actual runner)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadScheduledPosts() {
  const sched = JSON.parse(localStorage.getItem('ap_scheduled') || '[]');
  const list = document.getElementById('sched-list');
  const mini = document.getElementById('sched-mini-list');
  if (!sched.length) {
    list.innerHTML = '<div class="empty">No scheduled posts.<br>Generate a message and click Schedule.</div>';
    mini.innerHTML = '<div class="sm-row"><span class="sm-title" style="color:var(--dim);">None upcoming</span></div>';
    return;
  }
  const sorted = [...sched].sort((a,b) => new Date(a.datetime) - new Date(b.datetime));
  list.innerHTML = sorted.map((s,i) => {
    const isPast = new Date(s.datetime) < new Date();
    return `<div class="sched-item">
      <span class="si-status ${s.sent ? 'si-sent' : (isPast ? 'si-sent' : 'si-pending')}" title="${s.sent ? 'Sent' : (isPast ? 'Missed' : 'Pending')}"></span>
      <div class="si-time">${new Date(s.datetime).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
      <div class="si-info">
        <div class="si-title">${s.title}</div>
        <div class="si-ch">${s.channels || 'All channels'} ${s.sent ? '¬∑ ‚úì Sent' : (isPast ? '¬∑ Missed' : '')}</div>
      </div>
      <button class="si-del" onclick="removeScheduled('${s.id}')">‚úï</button>
    </div>`;
  }).join('');
  const upcoming = sorted.filter(s => !s.sent && new Date(s.datetime) > new Date()).slice(0, 3);
  mini.innerHTML = upcoming.length ? upcoming.map(s => `
    <div class="sm-row">
      <span class="sm-title">${s.title.substring(0,28)}</span>
      <span class="sm-time">${new Date(s.datetime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
    </div>`).join('') : '<div class="sm-row"><span class="sm-title" style="color:var(--dim);">None upcoming</span></div>';
}

function schedulePost() {
  const dt = document.getElementById('sched-dt').value;
  if (!dt) { toast('Pick a date and time', 'err'); return; }
  if (new Date(dt) < new Date()) { toast('Choose a future time', 'err'); return; }
  const msg = document.getElementById('sched-msg-preview').value || generatedMsg || '';
  if (!msg) { toast('Add a message to schedule', 'err'); return; }
  const sched = JSON.parse(localStorage.getItem('ap_scheduled') || '[]');
  sched.push({
    id: Date.now().toString(),
    datetime: dt,
    title: msg.substring(0, 35) + '‚Ä¶',
    channels: document.getElementById('sched-channels').value,
    message: msg,
    sent: false,
    createdAt: new Date().toISOString()
  });
  localStorage.setItem('ap_scheduled', JSON.stringify(sched));
  loadScheduledPosts();
  closeModal('modal-schedule');
  toast(`Scheduled for ${new Date(dt).toLocaleString()} ‚úì`, 'ok');
}

function removeScheduled(id) {
  let sched = JSON.parse(localStorage.getItem('ap_scheduled') || '[]');
  sched = sched.filter(s => s.id !== id);
  localStorage.setItem('ap_scheduled', JSON.stringify(sched));
  loadScheduledPosts();
  toast('Removed', 'inf');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CUSTOM TEMPLATES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadCustomTemplates() {
  customTemplates = JSON.parse(localStorage.getItem('ap_templates') || '[]');
  const tplRow = document.querySelector('.tpl-row');
  customTemplates.forEach(t => {
    const chip = document.createElement('span');
    chip.className = 'tpl-chip';
    chip.textContent = '‚≠ê ' + t.name;
    chip.onclick = () => pickTpl(chip, 'custom_' + t.name);
    tplRow.appendChild(chip);
  });
}

function saveTemplate() {
  const name = document.getElementById('tpl-name').value.trim();
  const prompt = document.getElementById('tpl-prompt').value.trim();
  if (!name) { toast('Enter a template name', 'err'); return; }
  const templates = JSON.parse(localStorage.getItem('ap_templates') || '[]');
  templates.push({ name, trigger: document.getElementById('tpl-trigger').value, prompt, createdAt: new Date().toISOString() });
  localStorage.setItem('ap_templates', JSON.stringify(templates));
  document.getElementById('tpl-name').value = '';
  document.getElementById('tpl-prompt').value = '';
  loadCustomTemplates();
  closeModal('modal-tpl');
  toast(`Template "${name}" saved! ‚úì`, 'ok');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UI HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setType(type, el) {
  currentType = type;
  document.querySelectorAll('.ttab').forEach(t => t.classList.remove('on'));
  el.classList.add('on');
  const isMatch = ['live','preview','prediction'].includes(type);
  document.getElementById('match-sec-hdr').style.display = isMatch ? 'flex' : 'none';
  document.getElementById('match-search-wrap').style.display = isMatch ? 'flex' : 'none';
  document.getElementById('custom-prompt').style.display = type === 'custom' ? 'block' : 'none';
  document.getElementById('standings-opts').style.display = type === 'standings' ? 'block' : 'none';
  document.getElementById('prediction-opts').style.display = type === 'prediction' ? 'block' : 'none';
}

function switchMid(view, el) {
  currentMid = view;
  const views = ['message','events','fixtures','stats','history','automation','schedule'];
  views.forEach(v => {
    const e = document.getElementById('view-' + v);
    if (!e) return;
    if (v === view) {
      e.style.display = 'flex';
      e.style.flexDirection = 'column';
      e.style.height = '100%';
      e.style.overflow = 'hidden';
    } else {
      e.style.display = 'none';
    }
  });
  document.querySelectorAll('.mtab').forEach(t => t.classList.remove('on'));
  if (el) {
    el.classList.add('on');
  } else {
    const tabIdx = views.indexOf(view);
    document.querySelectorAll('.mtab')[tabIdx]?.classList.add('on');
  }
  if (view === 'fixtures') loadFixtures();
}

function pickTpl(el, tpl) {
  document.querySelectorAll('.tpl-chip').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  currentTpl = tpl;
}

function pickPred(el, type) {
  predictionType = type;
  document.querySelectorAll('.pred-opt').forEach(o => o.classList.remove('sel'));
  el.classList.add('sel');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AFFILIATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadAffiliate() {
  const aff = JSON.parse(localStorage.getItem('ap_affiliate') || '{}');
  if (aff.label) document.getElementById('aff-label').value = aff.label;
  if (aff.url)   document.getElementById('aff-url').value = aff.url;
}

function saveAffiliate() {
  const aff = {
    label: document.getElementById('aff-label').value.trim(),
    url: document.getElementById('aff-url').value.trim()
  };
  localStorage.setItem('ap_affiliate', JSON.stringify(aff));
  toast('Affiliate link saved ‚úì', 'ok');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODALS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-bg').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.querySelectorAll('.modal-bg.open').forEach(m => m.classList.remove('open'));
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TOAST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TOAST_CLASSES = { ok:'t-ok', err:'t-err', inf:'t-inf', volt:'t-volt', amber:'t-amber' };
function toast(msg, type = 'ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = TOAST_CLASSES[type] || 't-ok';
  el.style.display = 'block';
  el.style.animation = 'none';
  el.offsetHeight;
  el.style.animation = '';
  clearTimeout(el._t);
  el._t = setTimeout(() => el.style.display = 'none', 3500);
}
</script>
</body>
</html>